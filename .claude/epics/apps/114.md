---
created: 2025-10-03T18:53:58Z
updated: 2025-10-03T19:15:11Z
status: open
task_id: 002
title: 根配置更新
size: S
estimation: 30分钟
parallel: false
depends_on: [113]
github: https://github.com/ycc-im/noteum/issues/114
---

# Task 002: 根配置更新

## 概述

更新项目根目录的配置文件以适应新的 `apps/` + `packages/` 目录结构。主要涉及 `package.json` 中的 workspace 配置和所有构建脚本路径的调整。

## 技术细节

### 需要更新的配置

#### 1. package.json - workspace 配置
当前的过滤器模式需要更新以包含 `apps/` 目录：

**当前配置：**
```json
{
  "scripts": {
    "dev": "pnpm --filter \"./packages/*\" --parallel dev",
    "build": "pnpm --filter \"./packages/*\" --parallel build",
    "typecheck": "pnpm --filter \"./packages/*\" --parallel typecheck",
    "test": "pnpm --filter \"./packages/*\" --parallel test"
  }
}
```

**目标配置：**
```json
{
  "scripts": {
    "dev": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel dev",
    "build": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel build",
    "typecheck": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel typecheck",
    "test": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel test"
  }
}
```

#### 2. 特定应用脚本更新
需要更新引用特定应用的脚本：

**当前配置：**
```json
{
  "dev:tauri": "pnpm --filter @noteum/tauri dev",
  "build:tauri": "pnpm --filter @noteum/tauri build"
}
```

**目标配置：**
```json
{
  "dev:desktop": "pnpm --filter @noteum/tauri dev",
  "build:desktop": "pnpm --filter @noteum/tauri build"
}
```

### 配置更新策略

1. **保持向后兼容性**
   - 现有的包名不变
   - 现有的过滤器继续工作
   - 添加新的过滤器而不是替换

2. **渐进式更新**
   - 首先添加 `apps/` 过滤器
   - 保持 `packages/` 过滤器（用于 shared/ui）
   - 更新特定应用引用

## 执行步骤

### 1. 更新通用构建脚本
```json
{
  "dev": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel dev",
  "start": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel dev",
  "build": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel build",
  "typecheck": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel typecheck",
  "test": "pnpm --filter \"./apps/*\" --filter \"./packages/*\" --parallel test"
}
```

### 2. 更新特定应用脚本
```json
{
  "dev:web": "pnpm --filter web dev",
  "dev:desktop": "pnpm --filter @noteum/tauri dev",
  "build:web": "pnpm --filter web build",
  "build:desktop": "pnpm --filter @noteum/tauri build",
  "build:apps": "pnpm build:web && pnpm build:desktop"
}
```

### 3. 添加 pnpm workspace 配置
如果不存在 `pnpm-workspace.yaml`，需要创建：
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

## 验收标准

### 配置正确性
- [ ] `package.json` 中所有脚本包含 `./apps/*` 过滤器
- [ ] `package.json` 中所有脚本保持 `./packages/*` 过滤器
- [ ] 特定应用脚本引用正确的包名
- [ ] `pnpm-workspace.yaml` 正确配置（如果需要）

### 功能验证
- [ ] `pnpm install` 执行成功
- [ ] `pnpm dev` 尝试启动所有应用（可能失败，但应该识别所有包）
- [ ] `pnpm --filter web` 能找到 web 应用
- [ ] `pnpm --filter @noteum/tauri` 能找到 desktop 应用
- [ ] `pnpm --filter @noteum/server` 能找到 server 应用

### 语法验证
- [ ] `package.json` 语法正确（有效的 JSON）
- [ ] `pnpm-workspace.yaml` 语法正确（如果存在）
- [ ] 脚本路径格式正确

## 风险控制

### 配置备份
在修改前备份当前配置：
```bash
cp package.json package.json.backup
```

### 验证方法
每次修改后运行：
```bash
pnpm install --dry-run
```

### 回滚计划
如果配置错误：
```bash
cp package.json.backup package.json
pnpm install
```

## 技术约束

### pnpm 版本要求
- pnpm >= 7.0（支持多过滤器语法）
- Node.js >= 16

### 配置限制
- 必须保持现有包名不变
- 不能破坏现有的依赖关系
- 必须支持并行执行

## 完成定义

任务被认为完成当：

1. **配置更新完整**
   - 所有通用脚本包含 `apps/` 和 `packages/` 过滤器
   - 特定应用脚本引用正确
   - workspace 配置正确

2. **语法正确性**
   - 所有 JSON 文件语法有效
   - 所有 YAML 文件语法有效（如果适用）

3. **功能可用性**
   - `pnpm install` 成功
   - pnpm 能识别所有包
   - 过滤器工作正常

4. **准备构建验证**
   - 配置为 Task 003（应用间依赖）做好准备
   - 为 Task 005（构建验证）奠定基础

## 注意事项

- 此任务依赖于 Task 001 的完成
- 完成后，应用程序可能仍无法正常启动（依赖路径问题）
- Task 003 将处理应用间的路径引用问题
- 建议在 Task 003 完成后再进行全面的构建测试
