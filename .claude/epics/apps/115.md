---
created: 2025-10-03T18:53:58Z
updated: 2025-10-03T19:15:12Z
status: open
task_id: 003
title: 应用间依赖路径更新
size: S
estimation: 30分钟
parallel: false
depends_on: [114]
github: https://github.com/ycc-im/noteum/issues/115
---

# Task 003: 应用间依赖路径更新

## 概述

更新各个应用程序的 `package.json` 和 TypeScript 配置中的依赖引用路径，确保它们能够正确引用移动后的共享包和彼此之间的依赖关系。

## 技术细节

### 需要更新的文件

#### 1. 应用程序 package.json 文件
- `apps/web/package.json`
- `apps/desktop/package.json` (原 tauri)
- `apps/server/package.json`

#### 2. TypeScript 配置文件
- `apps/web/tsconfig.json`
- `apps/desktop/tsconfig.json`
- `apps/server/tsconfig.json`
- `tsconfig.json` (根配置)

### 路径更新映射

#### package.json 依赖更新
**当前路径（相对于 packages/ 位置）：**
```json
{
  "dependencies": {
    "@noteum/shared": "workspace:../shared",
    "@noteum/ui": "workspace:../ui"
  }
}
```

**目标路径（相对于 apps/ 位置）：**
```json
{
  "dependencies": {
    "@noteum/shared": "workspace:../packages/shared",
    "@noteum/ui": "workspace:../packages/ui"
  }
}
```

#### TypeScript 路径映射更新
**当前配置：**
```json
{
  "compilerOptions": {
    "paths": {
      "@noteum/shared/*": ["../shared/src/*"],
      "@noteum/ui/*": ["../ui/src/*"]
    }
  }
}
```

**目标配置：**
```json
{
  "compilerOptions": {
    "paths": {
      "@noteum/shared/*": ["../packages/shared/src/*"],
      "@noteum/ui/*": ["../packages/ui/src/*"]
    }
  }
}
```

### 应用间依赖处理

#### Web 应用可能的依赖
- `@noteum/shared`：共享工具和类型
- `@noteum/ui`：UI 组件库

#### Desktop 应用可能的依赖
- `@noteum/shared`：共享工具和类型
- `@noteum/ui`：UI 组件库（如果使用 Web 技术）

#### Server 应用可能的依赖
- `@noteum/shared`：共享工具和类型
- 可能不依赖 `@noteum/ui`

## 执行步骤

### 1. 检查当前依赖关系
```bash
# 检查每个应用的 package.json
cat apps/web/package.json | grep -A5 -B5 "dependencies"
cat apps/desktop/package.json | grep -A5 -B5 "dependencies"
cat apps/server/package.json | grep -A5 -B5 "dependencies"
```

### 2. 更新 workspace 依赖路径
对于每个应用的 `package.json`：
- 将 `workspace:../shared` 更新为 `workspace:../packages/shared`
- 将 `workspace:../ui` 更新为 `workspace:../packages/ui`
- 检查任何其他应用间的相互引用

### 3. 更新 TypeScript 路径映射
对于每个应用的 `tsconfig.json`：
- 更新 `paths` 配置中的相对路径
- 确保 `extends` 引用正确（如果有）
- 验证 `references` 配置（如果使用项目引用）

### 4. 更新根 TypeScript 配置
在 `tsconfig.json` 中：
- 更新 `references` 数组中的路径
- 确保包含所有移动后的应用

## 验收标准

### 依赖解析正确性
- [ ] 所有应用能够解析 `@noteum/shared` 包
- [ ] 所有应用能够解析 `@noteum/ui` 包（如果使用）
- [ ] 应用间的相互引用正确解析

### TypeScript 配置验证
- [ ] 每个应用的 `tsconfig.json` 中路径映射正确
- [ ] 根 `tsconfig.json` 的项目引用正确
- [ ] TypeScript 编译器能找到所有类型定义

### 工作区完整性
- [ ] `pnpm install` 执行成功且无警告
- [ ] workspace 依赖正确链接
- [ ] 依赖图完整且无循环依赖

### 编译验证
- [ ] `pnpm typecheck` 在所有应用中成功
- [ ] 导入语句能够正确解析
- [ ] 类型推断和检查正常工作

## 风险控制

### 依赖备份
在修改前备份所有 package.json：
```bash
find apps/ -name "package.json" -exec cp {} {}.backup \;
find apps/ -name "tsconfig.json" -exec cp {} {}.backup \;
```

### 渐进式验证
每修改一个应用后立即验证：
```bash
cd apps/[app-name]
pnpm install
pnpm typecheck
```

### 回滚策略
如果出现问题：
```bash
find apps/ -name "*.backup" | while read backup; do
  original=${backup%.backup}
  mv "$backup" "$original"
done
```

## 技术约束

### 路径格式要求
- 必须使用相对路径（../ 格式）
- workspace 协议格式：`workspace:相对路径`
- TypeScript 路径必须指向源码目录

### 兼容性要求
- 保持与现有构建工具的兼容性
- 不破坏 IDE 的智能提示功能
- 支持热重载和增量编译

### 依赖约束
- 不允许循环依赖
- 保持依赖层次清晰
- 避免不必要的跨应用依赖

## 完成定义

任务被认为完成当：

1. **路径引用正确**
   - 所有 workspace 依赖使用正确的相对路径
   - TypeScript 路径映射指向正确位置
   - 应用间引用路径准确

2. **依赖解析成功**
   - `pnpm install` 无错误和警告
   - 所有包能被正确识别和链接
   - workspace 依赖图完整

3. **TypeScript 编译通过**
   - 所有应用的 `pnpm typecheck` 成功
   - 类型定义正确解析
   - 导入语句无错误

4. **为构建准备就绪**
   - 配置为 Task 004（开发工具配置）做好准备
   - 为 Task 005（构建验证）奠定基础
   - 支持后续的开发和测试工作

## 注意事项

- 此任务依赖于 Task 002 的配置更新完成
- 完成后应用应该能够成功进行类型检查
- 某些运行时错误可能仍然存在，将在后续任务中解决
- 建议在完成后立即验证基本的 TypeScript 编译功能
