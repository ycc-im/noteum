---
name: æ•°æ®å±‚æ‰©å±•ï¼šåŸºäºIndexedDBä¼˜åŒ–çš„æ•°æ®ç»“æ„ï¼ˆTDDï¼‰
status: open
created: 2025-10-07T00:00:00Z
github: https://github.com/ycc-im/noteum/issues/128
depends_on: [008]
parallel: true
conflicts_with: []
---

# Task: æ•°æ®å±‚æ‰©å±•ï¼šåŸºäºIndexedDBä¼˜åŒ–çš„æ•°æ®ç»“æ„ï¼ˆTDDï¼‰

## Description

**é‡‡ç”¨TDDï¼ˆæµ‹è¯•é©±åŠ¨å¼€å‘ï¼‰æ–¹æ³•**æ‰©å±•ç°æœ‰Dexie.jsæ•°æ®åº“schemaï¼Œä¸ºbase-noteåŠŸèƒ½ä¼˜åŒ–æ•°æ®ç»“æ„è®¾è®¡ï¼šå®ç°æ‰å¹³åŒ–çš„view_positionså­˜å‚¨ã€åŸºäºæ•°ç»„å­—æ®µçš„æ ‡ç­¾ç³»ç»Ÿã€å±‚çº§å…³ç³»ç®¡ç†ï¼Œå»ºç«‹åŸºäºIndexedDBç‰¹æ€§çš„é«˜æ•ˆæ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢æœºåˆ¶ã€‚

**TDDå¼€å‘æµç¨‹**ï¼šä¸¥æ ¼éµå¾ªRed-Green-Refactorå¾ªç¯ï¼Œå…ˆå†™å¤±è´¥çš„æµ‹è¯•ï¼Œå†å®ç°åŠŸèƒ½ï¼Œæœ€åé‡æ„ä¼˜åŒ–ã€‚

## Acceptance Criteria

### ğŸ”´ TDDé˜¶æ®µï¼šæµ‹è¯•å…ˆè¡Œï¼ˆRedï¼‰
- [ ] **ç¼–å†™å®Œæ•´æµ‹è¯•å¥—ä»¶**ï¼šå…ˆä¸ºæ‰€æœ‰schemaå˜æ›´å’Œæ•°æ®è¿ç§»åŠŸèƒ½ç¼–å†™å¤±è´¥çš„æµ‹è¯•
- [ ] **å±‚çº§å…³ç³»æµ‹è¯•**ï¼šç¼–å†™parent_idsã€child_idsã€root_pathã€hierarchy_levelå­—æ®µçš„å®Œæ•´æµ‹è¯•
- [ ] **æ ‡ç­¾ç³»ç»Ÿæµ‹è¯•**ï¼šç¼–å†™extracted_tagsæ•°ç»„å­—æ®µå’Œtagsè¡¨çš„æµ‹è¯•
- [ ] **è¿ç§»åŠŸèƒ½æµ‹è¯•**ï¼šç¼–å†™schemaç‰ˆæœ¬å‡çº§å’Œæ•°æ®è¿ç§»çš„æµ‹è¯•
- [ ] **æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼šç¼–å†™multiEntryç´¢å¼•æŸ¥è¯¢æ€§èƒ½çš„åŸºå‡†æµ‹è¯•
- [ ] **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**ï¼šç¼–å†™å¼‚å¸¸æƒ…å†µå’Œè¾¹ç•Œå€¼çš„æµ‹è¯•ç”¨ä¾‹

### ğŸŸ¢ å®ç°é˜¶æ®µï¼šåŠŸèƒ½å®ç°ï¼ˆGreenï¼‰
- [ ] æ‰©å±•notesè¡¨ï¼Œæ·»åŠ æ‰å¹³åŒ–çš„view_positionså­—æ®µæ”¯æŒå¤šè§†å›¾ä½ç½®å­˜å‚¨
- [ ] åœ¨notesè¡¨ä¸­æ·»åŠ extracted_tagsæ•°ç»„å­—æ®µï¼Œæ”¯æŒé«˜æ•ˆæ ‡ç­¾æŸ¥è¯¢
- [ ] æ·»åŠ ç‹¬ç«‹çš„titleå­—æ®µï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ ‡é¢˜ï¼Œæœ€å¤§100å­—ç¬¦
- [ ] **å®ç°å±‚çº§å…³ç³»å­—æ®µ**ï¼šparent_idsã€child_idsã€root_pathã€hierarchy_level
- [ ] å®ç°tagsè¡¨çš„å®Œæ•´ç»“æ„ï¼ˆid, name, color, type, created_atï¼‰
- [ ] åˆ é™¤note_tagså…³è”è¡¨è®¾è®¡ï¼Œé‡‡ç”¨æ•°ç»„å­—æ®µç®€åŒ–æ ‡ç­¾ç®¡ç†
- [ ] å»ºç«‹schemaç‰ˆæœ¬ç®¡ç†æœºåˆ¶ï¼Œæ”¯æŒä»å½“å‰ç‰ˆæœ¬è¿ç§»åˆ°æ–°ç‰ˆæœ¬
- [ ] **å®ç°æ•°æ®è¿ç§»å‡½æ•°**ï¼šç¡®ä¿æ‰€æœ‰TDDæµ‹è¯•é€šè¿‡ï¼Œå‘åå…¼å®¹ç°æœ‰æ•°æ®
- [ ] **é…ç½®æ•°æ®åº“ç´¢å¼•**ï¼šå®ç°multiEntryç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- [ ] FlowèŠ‚ç‚¹æ˜¾ç¤ºä½¿ç”¨titleå­—æ®µè€Œécontentæˆªå–ï¼Œæå‡æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
- [ ] å®ç°HierarchyServiceå¤„ç†å±‚çº§å…³ç³»ç»´æŠ¤å’Œä¸¤ç§æ ¸å¿ƒæŸ¥è¯¢åœºæ™¯

### ğŸ”„ é‡æ„é˜¶æ®µï¼šä»£ç ä¼˜åŒ–ï¼ˆRefactorï¼‰
- [ ] **ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½**ï¼šåœ¨ä¿æŒæµ‹è¯•é€šè¿‡çš„å‰æä¸‹ä¼˜åŒ–ç´¢å¼•ç­–ç•¥
- [ ] **é‡æ„æ•°æ®è¿ç§»é€»è¾‘**ï¼šæé«˜è¿ç§»æ•ˆç‡å’Œé”™è¯¯å¤„ç†
- [ ] **ä¼˜åŒ–å†…å­˜ä½¿ç”¨**ï¼šå‡å°‘å±‚çº§å…³ç³»ç¼“å­˜çš„æ•°æ®å ç”¨
- [ ] **TDDè´¨é‡éªŒè¯**ï¼šç¡®ä¿æµ‹è¯•è¦†ç›–ç‡â‰¥90%ï¼Œæ‰€æœ‰æµ‹è¯•ç¨³å®šé€šè¿‡
- [ ] **ä»£ç æ¸…ç†**ï¼šç§»é™¤å†—ä½™ä»£ç ï¼Œæå‡å¯ç»´æŠ¤æ€§

## Technical Details

### TDDæµ‹è¯•è®¾è®¡

#### Schemaå˜æ›´æµ‹è¯•
```typescript
// src/services/storage/schema.test.ts
describe('Database Schema TDD', () => {
  describe('NoteRecord Schema', () => {
    it('should validate note with hierarchy fields', () => {
      const note = {
        id: 'note-1',
        title: 'Test Note',
        content: 'Test content',
        created_at: new Date(),
        updated_at: new Date(),
        parent_ids: ['parent-1'],
        child_ids: ['child-1', 'child-2'],
        root_path: ['root-1', 'parent-1'],
        hierarchy_level: 2,
        extracted_tags: ['tag1', 'tag2'],
        view_positions: {
          'daily': { x: 100, y: 200 },
          'tags': { x: 300, y: 400 }
        }
      };

      expect(SchemaValidator.validateNoteRecord(note)).toBe(true);
    });

    it('should reject invalid hierarchy data', () => {
      const invalidNote = {
        id: 'note-1',
        title: 'Test Note',
        content: 'Test content',
        created_at: new Date(),
        updated_at: new Date(),
        parent_ids: 'not-array', // åº”è¯¥æ˜¯æ•°ç»„
        child_ids: ['valid-array'],
        extracted_tags: null // åº”è¯¥æ˜¯æ•°ç»„
      };

      expect(SchemaValidator.validateNoteRecord(invalidNote)).toBe(false);
    });
  });
});
```

#### å±‚çº§å…³ç³»æµ‹è¯•
```typescript
// src/services/notes/HierarchyService.test.ts
describe('HierarchyService TDD', () => {
  let testDB: TestDatabase;

  beforeEach(async () => {
    testDB = TestDatabase.getInstance();
    await testDB.reset();
    await testDB.seedTestData();
  });

  describe('buildHierarchyGraph', () => {
    it('should build hierarchy graph from notes array', () => {
      const notes = [
        TestHelpers.createMockNote({
          id: 'parent',
          child_ids: ['child1', 'child2']
        }),
        TestHelpers.createMockNote({
          id: 'child1',
          parent_ids: ['parent']
        }),
        TestHelpers.createMockNote({
          id: 'child2',
          parent_ids: ['parent']
        })
      ];

      const graph = HierarchyService.buildHierarchyGraph(notes);

      expect(graph.get('parent')).toContain('child1');
      expect(graph.get('parent')).toContain('child2');
      expect(graph.get('child1')).toBeUndefined();
    });
  });

  describe('getAllDescendants', () => {
    it('should get all descendants using cached root_path', async () => {
      // è®¾ç½®æµ‹è¯•æ•°æ®
      await setupHierarchyTestData();

      const result = await HierarchyService.getAllDescendants('root', testDB.getDB());

      expect(result.descendants).toContain('child1');
      expect(result.descendants).toContain('grandchild1');
      expect(result.totalCount).toBeGreaterThan(0);
    });
  });
});
```

#### æ•°æ®è¿ç§»æµ‹è¯•
```typescript
// src/services/storage/migration.test.ts
describe('Schema Migration TDD', () => {
  let testDB: TestDatabase;

  beforeEach(async () => {
    testDB = TestDatabase.getInstance();
    await testDB.reset();
    // è®¾ç½®v1 schemaçš„æµ‹è¯•æ•°æ®
    await setupV1TestData();
  });

  it('should migrate from v1 to v2 schema', async () => {
    const migrator = new SchemaMigrator(testDB.getDB());

    // æ‰§è¡Œè¿ç§»
    await migrator.migrateToVersion(2);

    // éªŒè¯è¿ç§»ç»“æœ
    const notes = await testDB.getDB().notes.toArray();
    const migratedNote = notes.find(n => n.id === 'test-note-1');

    expect(migratedNote).toBeDefined();
    expect(migratedNote.title).toBe('Generated Title from Content');
    expect(migratedNote.parent_ids).toEqual([]);
    expect(migratedNote.child_ids).toEqual([]);
    expect(migratedNote.extracted_tags).toContain('work');
  });

  it('should handle migration errors gracefully', async () => {
    // æ¨¡æ‹Ÿè¿ç§»é”™è¯¯
    const migrator = new SchemaMigrator(testDB.getDB());
    jest.spyOn(migrator, 'migrateNotes').mockRejectedValue(new Error('Migration failed'));

    await expect(migrator.migrateToVersion(2)).rejects.toThrow('Migration failed');
  });
});
```

#### æ€§èƒ½åŸºå‡†æµ‹è¯•
```typescript
// src/test/performance/database.test.ts
describe('Database Performance TDD', () => {
  it('should query parent_ids within performance threshold', async () => {
    const testDB = TestDatabase.getInstance();
    await setupLargeDataset(1000); // 1000æ¡è®°å½•

    const startTime = performance.now();

    const results = await testDB.getDB()
      .notes
      .where('parent_ids')
      .equals('parent-123')
      .toArray();

    const endTime = performance.now();

    expect(endTime - startTime).toBeLessThan(50); // 50mså†…å®Œæˆ
    expect(results.length).toBeGreaterThan(0);
  });

  it('should handle large hierarchy queries efficiently', async () => {
    const testDB = TestDatabase.getInstance();
    await setupDeepHierarchy(10); // 10å±‚æ·±åº¦

    const startTime = performance.now();

    const result = await HierarchyService.getAllDescendants('root', testDB.getDB());

    const endTime = performance.now();

    expect(endTime - startTime).toBeLessThan(100); // 100mså†…å®Œæˆ
    expect(result.descendants.length).toBeGreaterThan(50); // è‡³å°‘50ä¸ªåä»£
  });
});
```

### Schemaè®¾è®¡ï¼ˆåŸºäºIndexedDBç‰¹æ€§ä¼˜åŒ–ï¼‰

#### notesè¡¨æ‰©å±•
```typescript
interface NoteRecord {
  // åŸºç¡€å­—æ®µ
  id: string;
  title: string;           // ä¸“é—¨çš„æ ‡é¢˜å­—æ®µï¼Œæœ€å¤§100å­—ç¬¦ï¼Œç”¨äºFlowèŠ‚ç‚¹æ˜¾ç¤º
  content: string;         // å®Œæ•´Markdownå†…å®¹
  created_at: Date;
  updated_at: Date;

  // ä¸Šä¸‹çº§å…³ç³»å­—æ®µï¼ˆåŸºäºIndexedDBä¼˜åŒ–ï¼‰
  parent_ids: string[];        // ç›´æ¥çˆ¶èŠ‚ç‚¹IDæ•°ç»„ï¼ŒmultiEntryç´¢å¼•
  child_ids: string[];         // ç›´æ¥å­èŠ‚ç‚¹IDæ•°ç»„ï¼ˆå†—ä½™ç¼“å­˜ï¼‰ï¼ŒmultiEntryç´¢å¼•
  root_path?: string[];        // ä»æ ¹èŠ‚ç‚¹åˆ°å½“å‰èŠ‚ç‚¹çš„è·¯å¾„ç¼“å­˜ï¼ŒmultiEntryç´¢å¼•
  hierarchy_level?: number;    // å±‚çº§æ·±åº¦ç¼“å­˜

  // å…¶ä»–æ–°å¢å­—æ®µï¼ˆåŸºäºIndexedDBä¼˜åŒ–ï¼‰
  extracted_tags: string[];  // ç²¾ç¡®æå–çš„æ ‡ç­¾æ•°ç»„
  view_positions: {
    // æ‰å¹³åŒ–ç»“æ„ï¼Œç›´æ¥è®¿é—®æ€§èƒ½æ›´ä½³
    [viewId: string]: { x: number; y: number };
    // ç¤ºä¾‹ï¼š
    // "2025-05-05": { x: 100, y: 200 },
    // "#work": { x: 300, y: 400 },
    // "project-alpha": { x: 500, y: 600 }
  };
}
```

### ä¸Šä¸‹çº§å…³ç³»è®¾è®¡è¯¦è§£

#### æ ¸å¿ƒè®¾è®¡å†³ç­–
åŸºäºä¸¤ä¸ªæ ¸å¿ƒä½¿ç”¨åœºæ™¯çš„ä¼˜åŒ–ï¼š

**åœºæ™¯1ï¼šç”»å¸ƒå…³ç³»æ„å»º** - å½“æ‰€æœ‰noteså·²åœ¨å†…å­˜ä¸­æ—¶
- ä½¿ç”¨`parent_ids`/`child_ids`æ•°ç»„å­—æ®µï¼ŒO(1)ç›´æ¥è®¿é—®
- æ— éœ€é¢å¤–æ•°æ®åº“æŸ¥è¯¢ï¼Œå†…å­˜ä¸­æ„å»ºå…³ç³»å›¾
- æœ€é€‚åˆFlowç”»å¸ƒçš„å®æ—¶äº¤äº’åœºæ™¯

**åœºæ™¯2ï¼šå­å­™èŠ‚ç‚¹æŸ¥è¯¢** - ä»¥æŸä¸ªnoteä¸ºä¸»èŠ‚ç‚¹è·å–æ‰€æœ‰å­å­™
- ä¼˜å…ˆä½¿ç”¨`root_path`ç¼“å­˜å­—æ®µï¼ŒO(1)æŸ¥è¯¢
- ç¼“å­˜å¤±æ•ˆæ—¶ä½¿ç”¨`child_ids`é€’å½’æŸ¥è¯¢ï¼ŒO(m)æ€§èƒ½
- é€šè¿‡multiEntryç´¢å¼•ä¼˜åŒ–æ•°ç»„å­—æ®µæŸ¥è¯¢

#### TDDå®ç°è¦ç‚¹

**Redé˜¶æ®µ**ï¼š
- å…ˆå†™æ‰€æœ‰åŠŸèƒ½çš„å¤±è´¥æµ‹è¯•
- åŒ…å«æ­£å¸¸æƒ…å†µã€è¾¹ç•Œæƒ…å†µã€å¼‚å¸¸æƒ…å†µçš„æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•å®šä¹‰æ€§èƒ½é¢„æœŸ

**Greené˜¶æ®µ**ï¼š
- å®ç°æœ€å°åŠŸèƒ½è®©æµ‹è¯•é€šè¿‡
- ä¸è¿½æ±‚å®Œç¾ï¼Œé‡ç‚¹æ˜¯è®©æµ‹è¯•ä»çº¢å˜ç»¿
- é€æ­¥å®ç°æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹

**Refactoré˜¶æ®µ**ï¼š
- åœ¨ä¿æŒæµ‹è¯•é€šè¿‡çš„å‰æä¸‹ä¼˜åŒ–ä»£ç 
- æå‡æ€§èƒ½ã€å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- é‡æ„æµ‹è¯•æœ¬èº«ï¼Œæé«˜æµ‹è¯•è´¨é‡

### ä»£ç æ–‡ä»¶å½±å“

#### TDDæµ‹è¯•æ–‡ä»¶ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
- `src/services/storage/schema.test.ts` - Schemaå˜æ›´çš„å®Œæ•´æµ‹è¯•å¥—ä»¶
- `src/services/storage/migration.test.ts` - æ•°æ®è¿ç§»åŠŸèƒ½çš„æµ‹è¯•
- `src/services/notes/HierarchyService.test.ts` - å±‚çº§å…³ç³»æœåŠ¡çš„æµ‹è¯•
- `src/utils/tagExtractor.test.ts` - æ ‡ç­¾æå–å·¥å…·çš„æµ‹è¯•
- `src/test/performance/database.test.ts` - æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½åŸºå‡†æµ‹è¯•
- `src/test/fixtures/notes.ts` - æµ‹è¯•æ•°æ®å·¥å‚å’Œå›ºå®šæ•°æ®

#### æ ¸å¿ƒå®ç°æ–‡ä»¶
- `src/services/storage/schema.ts` - æ‰©å±•schemaå®šä¹‰å’Œç±»å‹
- `src/services/storage/migration.ts` - æ•°æ®è¿ç§»é€»è¾‘å®ç°
- `src/services/notes/HierarchyService.ts` - å±‚çº§å…³ç³»æœåŠ¡å®ç°
- `src/utils/tagExtractor.ts` - æ ‡ç­¾æå–å·¥å…·å®ç°

## Dependencies

- [ ] **ä»»åŠ¡008ï¼šTDDåŸºç¡€è®¾æ–½**å®Œæˆï¼Œæµ‹è¯•æ¡†æ¶å°±ä½
- [ ] ç°æœ‰Dexie.jså­˜å‚¨ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
- [ ] TypeScriptç±»å‹ç³»ç»Ÿå®Œæ•´
- [ ] å½“å‰schema v1ç¨³å®šè¿è¡Œ

## Effort Estimate

- Size: Lï¼ˆåŒ…å«å¤§é‡æµ‹è¯•å·¥ä½œï¼‰
- Days: 3-4å¤©
- Parallel: falseï¼ˆä¾èµ–TDDåŸºç¡€è®¾æ–½ï¼‰

### å·¥ä½œé‡åˆ†è§£
- **TDDæµ‹è¯•ç¼–å†™**ï¼š1.5å¤©ï¼ˆæœ€é‡è¦ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰
- **åŠŸèƒ½å®ç°**ï¼š1.5å¤©ï¼ˆè®©æµ‹è¯•é€šè¿‡ï¼‰
- **é‡æ„ä¼˜åŒ–**ï¼š0.5å¤©ï¼ˆæ€§èƒ½å’Œä»£ç è´¨é‡ï¼‰
- **é›†æˆéªŒè¯**ï¼š0.5å¤©ï¼ˆç«¯åˆ°ç«¯æµ‹è¯•ï¼‰

## Definition of Done

- [ ] **TDDæµç¨‹å®Œæ•´**ï¼šRed-Green-Refactorå¾ªç¯å®Œæ•´æ‰§è¡Œ
- [ ] **æµ‹è¯•è¦†ç›–ç‡**ï¼šæ ¸å¿ƒåŠŸèƒ½å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥90%
- [ ] **æ€§èƒ½è¾¾æ ‡**ï¼šæ‰€æœ‰æ€§èƒ½åŸºå‡†æµ‹è¯•é€šè¿‡
- [ ] **è¿ç§»ç¨³å®š**ï¼šæ•°æ®è¿ç§»åŠŸèƒ½ç¨³å®šå¯é ï¼Œå‘åå…¼å®¹
- [ ] **å±‚çº§å…³ç³»**ï¼šä¸¤ç§æŸ¥è¯¢åœºæ™¯æ€§èƒ½ç¬¦åˆè®¾è®¡é¢„æœŸ
- [ ] **ä»£ç è´¨é‡**ï¼šé€šè¿‡æ‰€æœ‰lintingå’Œç±»å‹æ£€æŸ¥
- [ ] **é›†æˆæµ‹è¯•**ï¼šä¸å…¶ä»–æ¨¡å—é›†æˆæ— é—®é¢˜
- [ ] **æ–‡æ¡£æ›´æ–°**ï¼šTDDæµ‹è¯•ç”¨ä¾‹æœ¬èº«å°±æ˜¯åŠŸèƒ½æ–‡æ¡£