---
name: 数据层扩展：基于IndexedDB优化的数据结构（TDD）
status: open
created: 2025-10-07T00:00:00Z
github: https://github.com/ycc-im/noteum/issues/128
depends_on: [008]
parallel: true
conflicts_with: []
---

# Task: 数据层扩展：基于IndexedDB优化的数据结构（TDD）

## Description

**采用TDD（测试驱动开发）方法**扩展现有Dexie.js数据库schema，为base-note功能优化数据结构设计：实现扁平化的view_positions存储、基于数组字段的标签系统、层级关系管理，建立基于IndexedDB特性的高效数据存储和查询机制。

**TDD开发流程**：严格遵循Red-Green-Refactor循环，先写失败的测试，再实现功能，最后重构优化。

## Acceptance Criteria

### 🔴 TDD阶段：测试先行（Red）
- [ ] **编写完整测试套件**：先为所有schema变更和数据迁移功能编写失败的测试
- [ ] **层级关系测试**：编写parent_ids、child_ids、root_path、hierarchy_level字段的完整测试
- [ ] **标签系统测试**：编写extracted_tags数组字段和tags表的测试
- [ ] **迁移功能测试**：编写schema版本升级和数据迁移的测试
- [ ] **性能基准测试**：编写multiEntry索引查询性能的基准测试
- [ ] **边界条件测试**：编写异常情况和边界值的测试用例

### 🟢 实现阶段：功能实现（Green）
- [ ] 扩展notes表，添加扁平化的view_positions字段支持多视图位置存储
- [ ] 在notes表中添加extracted_tags数组字段，支持高效标签查询
- [ ] 添加独立的title字段，支持用户自定义标题，最大100字符
- [ ] **实现层级关系字段**：parent_ids、child_ids、root_path、hierarchy_level
- [ ] 实现tags表的完整结构（id, name, color, type, created_at）
- [ ] 删除note_tags关联表设计，采用数组字段简化标签管理
- [ ] 建立schema版本管理机制，支持从当前版本迁移到新版本
- [ ] **实现数据迁移函数**：确保所有TDD测试通过，向后兼容现有数据
- [ ] **配置数据库索引**：实现multiEntry索引优化查询性能
- [ ] Flow节点显示使用title字段而非content截取，提升性能和用户体验
- [ ] 实现HierarchyService处理层级关系维护和两种核心查询场景

### 🔄 重构阶段：代码优化（Refactor）
- [ ] **优化查询性能**：在保持测试通过的前提下优化索引策略
- [ ] **重构数据迁移逻辑**：提高迁移效率和错误处理
- [ ] **优化内存使用**：减少层级关系缓存的数据占用
- [ ] **TDD质量验证**：确保测试覆盖率≥90%，所有测试稳定通过
- [ ] **代码清理**：移除冗余代码，提升可维护性

## Technical Details

### TDD测试设计

#### Schema变更测试
```typescript
// src/services/storage/schema.test.ts
describe('Database Schema TDD', () => {
  describe('NoteRecord Schema', () => {
    it('should validate note with hierarchy fields', () => {
      const note = {
        id: 'note-1',
        title: 'Test Note',
        content: 'Test content',
        created_at: new Date(),
        updated_at: new Date(),
        parent_ids: ['parent-1'],
        child_ids: ['child-1', 'child-2'],
        root_path: ['root-1', 'parent-1'],
        hierarchy_level: 2,
        extracted_tags: ['tag1', 'tag2'],
        view_positions: {
          'daily': { x: 100, y: 200 },
          'tags': { x: 300, y: 400 }
        }
      };

      expect(SchemaValidator.validateNoteRecord(note)).toBe(true);
    });

    it('should reject invalid hierarchy data', () => {
      const invalidNote = {
        id: 'note-1',
        title: 'Test Note',
        content: 'Test content',
        created_at: new Date(),
        updated_at: new Date(),
        parent_ids: 'not-array', // 应该是数组
        child_ids: ['valid-array'],
        extracted_tags: null // 应该是数组
      };

      expect(SchemaValidator.validateNoteRecord(invalidNote)).toBe(false);
    });
  });
});
```

#### 层级关系测试
```typescript
// src/services/notes/HierarchyService.test.ts
describe('HierarchyService TDD', () => {
  let testDB: TestDatabase;

  beforeEach(async () => {
    testDB = TestDatabase.getInstance();
    await testDB.reset();
    await testDB.seedTestData();
  });

  describe('buildHierarchyGraph', () => {
    it('should build hierarchy graph from notes array', () => {
      const notes = [
        TestHelpers.createMockNote({
          id: 'parent',
          child_ids: ['child1', 'child2']
        }),
        TestHelpers.createMockNote({
          id: 'child1',
          parent_ids: ['parent']
        }),
        TestHelpers.createMockNote({
          id: 'child2',
          parent_ids: ['parent']
        })
      ];

      const graph = HierarchyService.buildHierarchyGraph(notes);

      expect(graph.get('parent')).toContain('child1');
      expect(graph.get('parent')).toContain('child2');
      expect(graph.get('child1')).toBeUndefined();
    });
  });

  describe('getAllDescendants', () => {
    it('should get all descendants using cached root_path', async () => {
      // 设置测试数据
      await setupHierarchyTestData();

      const result = await HierarchyService.getAllDescendants('root', testDB.getDB());

      expect(result.descendants).toContain('child1');
      expect(result.descendants).toContain('grandchild1');
      expect(result.totalCount).toBeGreaterThan(0);
    });
  });
});
```

#### 数据迁移测试
```typescript
// src/services/storage/migration.test.ts
describe('Schema Migration TDD', () => {
  let testDB: TestDatabase;

  beforeEach(async () => {
    testDB = TestDatabase.getInstance();
    await testDB.reset();
    // 设置v1 schema的测试数据
    await setupV1TestData();
  });

  it('should migrate from v1 to v2 schema', async () => {
    const migrator = new SchemaMigrator(testDB.getDB());

    // 执行迁移
    await migrator.migrateToVersion(2);

    // 验证迁移结果
    const notes = await testDB.getDB().notes.toArray();
    const migratedNote = notes.find(n => n.id === 'test-note-1');

    expect(migratedNote).toBeDefined();
    expect(migratedNote.title).toBe('Generated Title from Content');
    expect(migratedNote.parent_ids).toEqual([]);
    expect(migratedNote.child_ids).toEqual([]);
    expect(migratedNote.extracted_tags).toContain('work');
  });

  it('should handle migration errors gracefully', async () => {
    // 模拟迁移错误
    const migrator = new SchemaMigrator(testDB.getDB());
    jest.spyOn(migrator, 'migrateNotes').mockRejectedValue(new Error('Migration failed'));

    await expect(migrator.migrateToVersion(2)).rejects.toThrow('Migration failed');
  });
});
```

#### 性能基准测试
```typescript
// src/test/performance/database.test.ts
describe('Database Performance TDD', () => {
  it('should query parent_ids within performance threshold', async () => {
    const testDB = TestDatabase.getInstance();
    await setupLargeDataset(1000); // 1000条记录

    const startTime = performance.now();

    const results = await testDB.getDB()
      .notes
      .where('parent_ids')
      .equals('parent-123')
      .toArray();

    const endTime = performance.now();

    expect(endTime - startTime).toBeLessThan(50); // 50ms内完成
    expect(results.length).toBeGreaterThan(0);
  });

  it('should handle large hierarchy queries efficiently', async () => {
    const testDB = TestDatabase.getInstance();
    await setupDeepHierarchy(10); // 10层深度

    const startTime = performance.now();

    const result = await HierarchyService.getAllDescendants('root', testDB.getDB());

    const endTime = performance.now();

    expect(endTime - startTime).toBeLessThan(100); // 100ms内完成
    expect(result.descendants.length).toBeGreaterThan(50); // 至少50个后代
  });
});
```

### Schema设计（基于IndexedDB特性优化）

#### notes表扩展
```typescript
interface NoteRecord {
  // 基础字段
  id: string;
  title: string;           // 专门的标题字段，最大100字符，用于Flow节点显示
  content: string;         // 完整Markdown内容
  created_at: Date;
  updated_at: Date;

  // 上下级关系字段（基于IndexedDB优化）
  parent_ids: string[];        // 直接父节点ID数组，multiEntry索引
  child_ids: string[];         // 直接子节点ID数组（冗余缓存），multiEntry索引
  root_path?: string[];        // 从根节点到当前节点的路径缓存，multiEntry索引
  hierarchy_level?: number;    // 层级深度缓存

  // 其他新增字段（基于IndexedDB优化）
  extracted_tags: string[];  // 精确提取的标签数组
  view_positions: {
    // 扁平化结构，直接访问性能更佳
    [viewId: string]: { x: number; y: number };
    // 示例：
    // "2025-05-05": { x: 100, y: 200 },
    // "#work": { x: 300, y: 400 },
    // "project-alpha": { x: 500, y: 600 }
  };
}
```

### 上下级关系设计详解

#### 核心设计决策
基于两个核心使用场景的优化：

**场景1：画布关系构建** - 当所有notes已在内存中时
- 使用`parent_ids`/`child_ids`数组字段，O(1)直接访问
- 无需额外数据库查询，内存中构建关系图
- 最适合Flow画布的实时交互场景

**场景2：子孙节点查询** - 以某个note为主节点获取所有子孙
- 优先使用`root_path`缓存字段，O(1)查询
- 缓存失效时使用`child_ids`递归查询，O(m)性能
- 通过multiEntry索引优化数组字段查询

#### TDD实现要点

**Red阶段**：
- 先写所有功能的失败测试
- 包含正常情况、边界情况、异常情况的测试
- 性能基准测试定义性能预期

**Green阶段**：
- 实现最小功能让测试通过
- 不追求完美，重点是让测试从红变绿
- 逐步实现每个测试用例

**Refactor阶段**：
- 在保持测试通过的前提下优化代码
- 提升性能、可读性和可维护性
- 重构测试本身，提高测试质量

### 代码文件影响

#### TDD测试文件（优先级最高）
- `src/services/storage/schema.test.ts` - Schema变更的完整测试套件
- `src/services/storage/migration.test.ts` - 数据迁移功能的测试
- `src/services/notes/HierarchyService.test.ts` - 层级关系服务的测试
- `src/utils/tagExtractor.test.ts` - 标签提取工具的测试
- `src/test/performance/database.test.ts` - 数据库查询性能基准测试
- `src/test/fixtures/notes.ts` - 测试数据工厂和固定数据

#### 核心实现文件
- `src/services/storage/schema.ts` - 扩展schema定义和类型
- `src/services/storage/migration.ts` - 数据迁移逻辑实现
- `src/services/notes/HierarchyService.ts` - 层级关系服务实现
- `src/utils/tagExtractor.ts` - 标签提取工具实现

## Dependencies

- [ ] **任务008：TDD基础设施**完成，测试框架就位
- [ ] 现有Dexie.js存储系统正常工作
- [ ] TypeScript类型系统完整
- [ ] 当前schema v1稳定运行

## Effort Estimate

- Size: L（包含大量测试工作）
- Days: 3-4天
- Parallel: false（依赖TDD基础设施）

### 工作量分解
- **TDD测试编写**：1.5天（最重要，优先级最高）
- **功能实现**：1.5天（让测试通过）
- **重构优化**：0.5天（性能和代码质量）
- **集成验证**：0.5天（端到端测试）

## Definition of Done

- [ ] **TDD流程完整**：Red-Green-Refactor循环完整执行
- [ ] **测试覆盖率**：核心功能单元测试覆盖率≥90%
- [ ] **性能达标**：所有性能基准测试通过
- [ ] **迁移稳定**：数据迁移功能稳定可靠，向后兼容
- [ ] **层级关系**：两种查询场景性能符合设计预期
- [ ] **代码质量**：通过所有linting和类型检查
- [ ] **集成测试**：与其他模块集成无问题
- [ ] **文档更新**：TDD测试用例本身就是功能文档