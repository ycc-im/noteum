---
name: Markdown渲染：依赖安装和基础渲染功能（TDD）
status: open
created: 2025-10-07T00:00:00Z
github: https://github.com/ycc-im/noteum/issues/129
depends_on: [008]
parallel: true
conflicts_with: []
---

# Task: Markdown渲染：依赖安装和基础渲染功能（TDD）

## Description

**采用TDD（测试驱动开发）方法**添加Markdown渲染所需的npm依赖包，配置基础Markdown渲染功能，支持代码高亮、GFM（GitHub Flavored Markdown）和表格等常用功能，为笔记系统提供内容展示能力。

**TDD开发流程**：严格遵循Red-Green-Refactor循环，先为每个Markdown功能编写失败的测试，再实现功能，最后优化性能和用户体验。

## Acceptance Criteria

### 🔴 TDD阶段：测试先行（Red）
- [ ] **编写Markdown渲染测试套件**：先为所有Markdown功能编写失败的测试
- [ ] **基础语法测试**：标题、列表、链接、图片、代码块等基础Markdown语法测试
- [ ] **GFM扩展测试**：表格、任务列表、删除线等GitHub Flavored Markdown功能测试
- [ ] **代码高亮测试**：多语言语法高亮、行号显示、复制功能等测试
- [ ] **性能测试**：大文档渲染性能、内存使用等基准测试
- [ ] **组件集成测试**：MarkdownRenderer组件与现有UI系统的集成测试

### 🟢 实现阶段：功能实现（Green）
- [ ] 安装react-markdown及相关依赖包
- [ ] 配置remark-gfm支持GitHub Flavored Markdown
- [ ] 集成react-syntax-highlighter实现代码语法高亮
- [ ] 创建基础的MarkdownRenderer组件，让TDD测试通过
- [ ] 支持常用Markdown语法（标题、列表、代码块、链接、图片）
- [ ] 实现代码主题切换功能
- [ ] 添加自定义Markdown样式，符合现有设计系统

### 🔄 重构阶段：代码优化（Refactor）
- [ ] **优化渲染性能**：在保持测试通过的前提下优化大文档渲染
- [ ] **组件重构**：提升MarkdownRenderer组件的可复用性和可维护性
- [ ] **样式优化**：优化CSS性能，减少重复代码
- [ ] **TDD质量验证**：确保测试覆盖率≥90%，所有测试稳定通过

## Technical Details

### TDD测试设计

#### Markdown基础功能测试
```typescript
// src/components/markdown/MarkdownRenderer.test.tsx
describe('MarkdownRenderer TDD', () => {
  describe('Basic Markdown Syntax', () => {
    it('should render headers correctly', () => {
      const content = '# H1 Header\n## H2 Header\n### H3 Header';

      const { getByRole } = render(
        <MarkdownRenderer content={content} />
      );

      expect(getByRole('heading', { level: 1 })).toHaveTextContent('H1 Header');
      expect(getByRole('heading', { level: 2 })).toHaveTextContent('H2 Header');
      expect(getByRole('heading', { level: 3 })).toHaveTextContent('H3 Header');
    });

    it('should render lists correctly', () => {
      const content = `- Item 1\n- Item 2\n  - Nested item`;

      const { getByRole } = render(
        <MarkdownRenderer content={content} />
      );

      expect(getByRole('list')).toBeInTheDocument();
      expect(getByRole('listitem')).toBeInTheDocument();
    });

    it('should render code blocks with syntax highlighting', () => {
      const content = '```javascript\nconst x = 1;\n```';

      const { getByText } = render(
        <MarkdownRenderer content={content} codeTheme="dark" />
      );

      expect(getByText('const x = 1;')).toBeInTheDocument();
      // 验证语法高亮CSS类被应用
      expect(getByText('const x = 1;')).toHaveClass('token-keyword');
    });

    it('should render links correctly', () => {
      const content = '[Link Text](https://example.com)';

      const { getByRole } = render(
        <MarkdownRenderer content={content} />
      );

      const link = getByRole('link');
      expect(link).toHaveTextContent('Link Text');
      expect(link).toHaveAttribute('href', 'https://example.com');
    });
  });

  describe('GFM Extensions', () => {
    it('should render tables correctly', () => {
      const content = `
| Header 1 | Header 2 |
|----------|----------|
| Cell 1   | Cell 2   |
| Cell 3   | Cell 4   |
      `.trim();

      const { getByRole } = render(
        <MarkdownRenderer content={content} enableGFM={true} />
      );

      expect(getByRole('table')).toBeInTheDocument();
      expect(getByRole('columnheader', { name: 'Header 1' })).toBeInTheDocument();
    });

    it('should render task lists correctly', () => {
      const content = '- [x] Completed task\n- [ ] Incomplete task';

      const { getAllByRole } = render(
        <MarkdownRenderer content={content} enableGFM={true} />
      );

      const checkboxes = getAllByRole('checkbox');
      expect(checkboxes).toHaveLength(2);
      expect(checkboxes[0]).toBeChecked();
      expect(checkboxes[1]).not.toBeChecked();
    });

    it('should render strikethrough text correctly', () => {
      const content = '~~Strikethrough text~~';

      const { getByText } = render(
        <MarkdownRenderer content={content} enableGFM={true} />
      );

      expect(getByText('Strikethrough text')).toHaveStyle('text-decoration: line-through');
    });
  });

  describe('Code Block Features', () => {
    it('should show line numbers when enabled', () => {
      const content = '```javascript\nline 1\nline 2\nline 3\n```';

      const { getByText } = render(
        <MarkdownRenderer content={content} showLineNumbers={true} />
      );

      expect(getByText('1')).toBeInTheDocument();
      expect(getByText('2')).toBeInTheDocument();
      expect(getByText('3')).toBeInTheDocument();
    });

    it('should support code copy functionality', async () => {
      const content = '```javascript\nconst code = "test";\n```';
      const user = userEvent.setup();

      const { getByRole } = render(
        <MarkdownRenderer content={content} enableCopy={true} />
      );

      const copyButton = getByRole('button', { name: /copy/i });
      await user.click(copyButton);

      // 验证复制功能
      expect(navigator.clipboard.writeText).toHaveBeenCalledWith('const code = "test";');
    });
  });

  describe('Theme Support', () => {
    it('should apply dark theme correctly', () => {
      const content = '```javascript\nconst x = 1;\n```';

      const { container } = render(
        <MarkdownRenderer content={content} codeTheme="dark" />
      );

      expect(container.querySelector('.dark-theme')).toBeInTheDocument();
    });

    it('should apply light theme correctly', () => {
      const content = '```javascript\nconst x = 1;\n```';

      const { container } = render(
        <MarkdownRenderer content={content} codeTheme="light" />
      );

      expect(container.querySelector('.light-theme')).toBeInTheDocument();
    });
  });
});
```

#### 性能测试
```typescript
// src/test/performance/markdown.test.tsx
describe('MarkdownRenderer Performance TDD', () => {
  it('should render large document within performance threshold', async () => {
    const largeContent = generateLargeMarkdownDocument(10000); // 10k字符

    const startTime = performance.now();

    const { container } = render(
      <MarkdownRenderer content={largeContent} />
    );

    const endTime = performance.now();

    expect(endTime - startTime).toBeLessThan(500); // 500ms内完成
    expect(container.firstChild).toBeInTheDocument();
  });

  it('should handle code block rendering efficiently', async () => {
    const contentWithMultipleCodeBlocks = generateDocumentWithCodeBlocks(50);

    const startTime = performance.now();

    render(
      <MarkdownRenderer content={contentWithMultipleCodeBlocks} />
    );

    const endTime = performance.now();

    expect(endTime - startTime).toBeLessThan(1000); // 1秒内完成
  });
});
```

#### 组件集成测试
```typescript
// src/components/markdown/integration.test.tsx
describe('MarkdownRenderer Integration TDD', () => {
  it('should integrate with existing design system', () => {
    const content = '# Test\nThis is a test content.';

    const { container } = render(
      <ThemeProvider theme="dark">
        <MarkdownRenderer content={content} />
      </ThemeProvider>
    );

    // 验证样式主题正确应用
    expect(container.querySelector('[data-theme="dark"]')).toBeInTheDocument();
  });

  it('should work within modal dialogs', () => {
    const content = 'Modal content with **bold** text.';

    const { getByText } = render(
      <Modal open>
        <MarkdownRenderer content={content} />
      </Modal>
    );

    expect(getByText('bold')).toHaveStyle('font-weight: bold');
  });
});
```

### 组件架构设计

#### MarkdownRenderer接口
```typescript
interface MarkdownRendererProps {
  content: string;
  className?: string;
  codeTheme?: 'dark' | 'light';
  enableGFM?: boolean;
  showLineNumbers?: boolean;
  enableCopy?: boolean;
  customComponents?: Record<string, React.ComponentType>;
  onLinkClick?: (url: string) => void;
}
```

#### CodeBlock组件接口
```typescript
interface CodeBlockProps {
  language?: string;
  children: string;
  theme?: 'dark' | 'light';
  showLineNumbers?: boolean;
  enableCopy?: boolean;
}
```

### TDD实现要点

#### Red阶段：失败的测试
- **基础语法测试**：标题、列表、链接、图片等元素正确渲染
- **GFM扩展测试**：表格、任务列表、删除线等高级功能
- **代码高亮测试**：语法高亮、行号、复制功能
- **性能基准测试**：大文档渲染时间、内存使用
- **集成测试**：与现有UI组件的兼容性

#### Green阶段：最小实现
- **依赖安装**：react-markdown、remark-gfm、react-syntax-highlighter
- **基础组件**：实现最简功能让测试通过
- **样式集成**：与shadcn/ui设计系统保持一致
- **错误处理**：处理无效Markdown和渲染错误

#### Refactor阶段：优化提升
- **性能优化**：虚拟化、懒加载、缓存机制
- **用户体验**：加载状态、错误提示、主题切换
- **代码质量**：组件拆分、复用性、可测试性

### 依赖包选择

```json
{
  "dependencies": {
    "react-markdown": "^9.0.1",
    "remark-gfm": "^4.0.0",
    "react-syntax-highlighter": "^15.5.0"
  }
}
```

### 代码文件影响

#### TDD测试文件（优先级最高）
- `src/components/markdown/MarkdownRenderer.test.tsx` - 主组件测试
- `src/components/markdown/CodeBlock.test.tsx` - 代码块组件测试
- `src/test/performance/markdown.test.tsx` - 性能基准测试
- `src/components/markdown/integration.test.tsx` - 集成测试

#### 核心实现文件
- `src/components/markdown/MarkdownRenderer.tsx` - 主渲染组件
- `src/components/markdown/CodeBlock.tsx` - 代码块组件
- `src/components/markdown/styles/` - Markdown专用样式文件
- `src/hooks/useMarkdown.ts` - Markdown相关hooks
- `src/utils/markdown.ts` - Markdown工具函数

## Dependencies

- [ ] **任务008：TDD基础设施**完成，测试框架就位
- [ ] React 19环境正常
- [ ] Tailwind CSS配置完整
- [ ] 现有组件库shadcn/ui可用

## Effort Estimate

- Size: M
- Days: 2天
- Parallel: true

### 工作量分解
- **TDD测试编写**：1天（编写所有功能的失败测试）
- **功能实现**：0.5天（安装依赖，实现基础功能）
- **重构优化**：0.5天（性能优化和代码质量提升）

## Definition of Done

- [ ] **TDD流程完整**：Red-Green-Refactor循环完整执行
- [ ] **依赖安装完成**：所有Markdown相关依赖安装成功，无版本冲突
- [ ] **功能完整**：基础Markdown、GFM、代码高亮功能全部实现
- [ ] **测试覆盖率**：核心功能单元测试覆盖率≥90%
- [ ] **性能达标**：大文档渲染性能测试通过
- [ ] **集成无问题**：与现有UI系统完美集成
- [ ] **代码质量**：通过所有linting和类型检查
- [ ] **用户体验**：主题切换、代码复制等功能流畅可用