---
name: Flow节点开发：NoteNode组件和基础交互
status: open
created: 2025-10-07T00:00:00Z
github: [待创建GitHub Issue]
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Flow节点开发：NoteNode组件和基础交互

## Description

基于现有FlowCanvas组件扩展，实现NoteNode自定义节点组件，支持笔记的创建、编辑、移动、删除等基础交互功能，集成Markdown渲染能力，建立React Flow与数据层的双向绑定机制。

## Acceptance Criteria

### 核心功能
- [ ] 扩展现有FlowCanvas，注册NoteNode自定义节点类型
- [ ] 实现NoteNode组件，支持笔记内容显示和基础交互
- [ ] 集成Markdown渲染功能，支持笔记内容实时预览
- [ ] 实现节点拖拽移动，位置变化自动保存到数据库

### 节点创建和编辑
- [ ] 添加节点创建功能，支持双击画布创建新笔记
- [ ] **实现点击节点编辑功能：点击节点在右边栏（右边半屏）打开详细编辑器**
- [ ] 右边栏编辑器支持标题、标签、内容的完整编辑
- [ ] 右边栏支持Markdown实时预览（分屏显示：编辑器|预览）
- [ ] 右边栏编辑器支持自动保存和手动保存
- [ ] 实现节点删除功能和确认机制

### 交互和状态管理
- [ ] 实现节点选中状态和工具栏集成
- [ ] 右边栏状态管理：打开/关闭/切换编辑节点
- [ ] 支持键盘快捷键：Esc关闭右边栏，Ctrl+S保存
- [ ] 右边栏响应式设计，支持移动端适配
- [ ] 优化节点样式，符合现有设计系统

### 测试和优化
- [ ] 编写组件测试确保交互功能正常
- [ ] 右边栏编辑器独立测试覆盖
- [ ] 性能优化：大节点列表的流畅操作

## Technical Details

### 组件架构设计

```typescript
// src/components/flow/nodes/NoteNode.tsx
interface NoteNodeProps {
  id: string;
  data: {
    title: string;
    content: string;
    created_at: Date;
    updated_at: Date;
    tags?: string[];
  };
  selected: boolean;
  dragging: boolean;
  onNodeClick?: (nodeId: string) => void;
}

// src/components/flow/FlowCanvas.tsx 扩展
interface FlowCanvasProps {
  // 现有props...
  onNoteCreate?: (position: { x: number; y: number }) => Promise<string>;
  onNoteUpdate?: (id: string, updates: Partial<Note>) => Promise<void>;
  onNoteDelete?: (id: string) => Promise<void>;
  onNodeSelect?: (nodeId: string | null) => void;
  enableNoteCreation?: boolean;
  selectedNodeId?: string | null;
}

// 新建：src/components/flow/NoteEditorPanel.tsx
interface NoteEditorPanelProps {
  noteId: string | null;
  isOpen: boolean;
  onClose: () => void;
  onSave: (id: string, updates: Partial<Note>) => Promise<void>;
  onDelete: (id: string) => Promise<void>;
}

// 新建：src/components/flow/FlowLayout.tsx
interface FlowLayoutProps {
  children: React.ReactNode;
  editorPanel: React.ReactNode;
  isEditorOpen: boolean;
}
```

### 实现特性

#### 核心功能
1. **自定义节点类型**：注册noteNode到React Flow节点类型系统
2. **双向数据绑定**：节点位置变化自动同步到数据库
3. **Markdown渲染**：集成任务002的MarkdownRenderer组件

#### 右边栏编辑系统
4. **点击编辑**：点击节点在右边半屏打开详细编辑器
5. **分屏编辑**：左边编辑器（50%），右边Markdown预览（50%）
6. **自动保存**：编辑内容自动保存，防止数据丢失
7. **响应式布局**：右边栏滑入/滑出动画，支持移动端适配

#### 交互优化
8. **节点交互**：hover效果、选中状态、拖拽预览
9. **键盘快捷键**：Esc关闭编辑器，Ctrl+S保存，Enter确认删除
10. **右键菜单**：节点右键显示操作菜单（编辑、删除、复制）
11. **双击创建**：画布空白处双击创建新笔记节点

#### 性能和体验
12. **性能优化**：大节点列表的虚拟化渲染
13. **状态管理**：Zustand管理编辑器状态和选中状态
14. **动画过渡**：平滑的打开/关闭动画和状态转换

### 数据流设计

```typescript
// stores/useFlowStore.ts 新建/扩展
interface FlowStore {
  // 节点状态
  nodes: FlowNode[];
  edges: FlowEdge[];
  selectedNodeIds: string[];

  // 右边栏编辑器状态
  editorState: {
    isOpen: boolean;
    editingNodeId: string | null;
    isDirty: boolean;
    isSaving: boolean;
  };

  // 操作方法
  createNote: (position: Point) => Promise<string>;
  updateNote: (id: string, updates: Partial<Note>) => Promise<void>;
  deleteNote: (id: string) => Promise<void>;
  moveNote: (id: string, position: Point) => Promise<void>;

  // 编辑器操作
  openEditor: (nodeId: string) => void;
  closeEditor: () => void;
  setEditingNode: (nodeId: string | null) => void;
  saveEditor: () => Promise<void>;
  autoSave: (debounceMs?: number) => void;

  // 视图状态
  currentView: 'daily' | 'tags' | 'timeline';
  isLoading: boolean;
}

// stores/useNoteStore.ts 扩展
interface NoteStore {
  // 现有状态...

  // Flow相关方法
  getNoteForFlow: (id: string) => Promise<Note | null>;
  updateNotePosition: (id: string, position: Point) => Promise<void>;
  batchUpdateNotes: (updates: Array<{id: string, updates: Partial<Note>}>) => Promise<void>;
}
```

### 代码文件影响

#### 核心组件
- `src/components/flow/nodes/NoteNode.tsx` - 新建笔记节点组件
- `src/components/flow/FlowCanvas.tsx` - 扩展现有画布组件
- `src/components/flow/NoteEditorPanel.tsx` - **新建右边栏编辑器组件**
- `src/components/flow/FlowLayout.tsx` - **新建布局容器组件**
- `src/components/flow/FlowToolbar.tsx` - 新建Flow工具栏组件

#### 状态管理
- `src/stores/useFlowStore.ts` - 新建Flow状态管理（包含编辑器状态）
- `src/hooks/useFlowNodes.ts` - 新建Flow相关hooks
- `src/hooks/useNoteEditor.ts` - **新建编辑器专用hooks**

#### 服务层
- `src/services/notes/NoteService.ts` - 扩展笔记服务层
- `src/services/flow/FlowService.ts` - **新建Flow服务层**

#### 样式和动画
- `src/components/flow/styles/NoteNode.styles.ts` - 节点样式
- `src/components/flow/styles/EditorPanel.styles.ts` - **编辑器样式和动画**
- `src/components/flow/styles/FlowLayout.styles.ts` - **布局样式**

#### 类型定义
- `src/types/flow.ts` - **新建Flow相关类型定义**
- `src/types/note.ts` - 扩展笔记类型定义

### UI设计规范

#### 右边栏编辑器布局
```
┌─────────────────────────────────────────────────────────────┐
│ Flow Canvas (50%)                   │ Editor Panel (50%)   │
│                                     │                      │
│  ┌─────┐  ┌─────┐  ┌─────┐         │ ┌─────────────────┐  │
│  │Node1│  │Node2│  │Node3│         │ │ Title Input     │  │
│  └─────┘  └─────┘  └─────┘         │ ├─────────────────┤  │
│                                     │ │ Tags Input      │  │
│                                     │ ├─────────────────┤  │
│                                     │ │ Content Editor  │  │
│                                     │ │ (50%)           │  │
│                                     │ ├─────────────────┤  │
│                                     │ │ Markdown Preview│  │
│                                     │ │ (50%)           │  │
│                                     │ └─────────────────┘  │
│                                     │ [Save] [Delete]     │
└─────────────────────────────────────────────────────────────┘
```

#### 编辑器功能特性
- **标题编辑**：单行输入，支持字数限制和实时验证
- **标签管理**：支持添加/删除标签，标签自动补全
- **内容编辑**：Markdown编辑器，支持语法高亮
- **实时预览**：分屏显示Markdown渲染结果
- **自动保存**：输入停止2秒后自动保存
- **保存状态**：显示保存状态（已保存/保存中/保存失败）

#### 节点设计规范
- **尺寸**：最小宽度180px，高度根据内容自适应
- **样式**：卡片式设计，圆角8px，阴影效果
- **状态**：默认/选中/悬停/拖拽四种状态
- **内容显示**：标题+摘要（最多2行）
- **标签显示**：最多显示3个标签，超出显示"+N"

## Dependencies

### 功能依赖
- [ ] 任务001数据层扩展完成
- [ ] 任务002 Markdown渲染组件完成
- [ ] 现有FlowCanvas组件正常运行

### 技术依赖
- [ ] React Flow 11.11.4依赖稳定
- [ ] Zustand状态管理可用
- [ ] TypeScript类型系统完整
- [ ] Tailwind CSS样式系统
- [ ] Monaco Editor或CodeMirror（可选，用于代码编辑）
- [ ] framer-motion动画库（用于平滑过渡）

## Effort Estimate

- Size: L
- Days: 4天
- Parallel: false

### 工作量分解
- **NoteNode组件开发**：1天（包含样式和交互）
- **右边栏编辑器**：1.5天（包含分屏编辑、自动保存）
- **FlowCanvas扩展**：0.5天（集成点击事件和状态管理）
- **状态管理和数据流**：0.5天（Zustand store和hooks）
- **测试和优化**：0.5天（单元测试和性能优化）

## Definition of Done

- [ ] NoteNode组件实现并通过测试
- [ ] **右边栏编辑器功能完整，支持分屏编辑和自动保存**
- [ ] 节点创建、编辑、移动、删除功能完整
- [ ] Markdown渲染集成正常
- [ ] 数据层双向绑定机制稳定
- [ ] 交互体验流畅，无卡顿现象
- [ ] 组件样式符合设计规范
- [ ] **键盘快捷键和响应式设计完成**
- [ ] 单元测试覆盖率达到85%以上
- [ ] 集成测试通过
- [ ] **100个节点操作流畅性能测试通过**
- [ ] 移动端适配测试通过
- [ ] 代码审查通过

## 风险和注意事项

### 技术风险
- **React Flow性能**：大量节点时可能出现性能问题，需要虚拟化
- **自动保存冲突**：多个自动保存请求可能导致数据竞争
- **状态同步**：节点位置和编辑器状态需要实时同步

### 用户体验风险
- **编辑器打开延迟**：大数据加载时可能影响用户体验
- **意外关闭**：用户可能误操作关闭编辑器导致数据丢失
- **移动端适配**：小屏幕上的分屏编辑体验需要优化

### 缓解措施
- 实现防抖自动保存和本地缓存
- 添加关闭确认机制
- 移动端使用全屏编辑器替代分屏
- 实现增量更新和懒加载优化性能

## Definition of Done

- [ ] NoteNode组件实现并通过测试
- [ ] **右边栏编辑器功能完整，支持分屏编辑和自动保存**
- [ ] 节点创建、编辑、移动、删除功能完整
- [ ] Markdown渲染集成正常
- [ ] 数据层双向绑定机制稳定
- [ ] 交互体验流畅，无卡顿现象
- [ ] 组件样式符合设计规范
- [ ] **键盘快捷键和响应式设计完成**
- [ ] 单元测试覆盖率达到85%以上
- [ ] 集成测试通过
- [ ] **100个节点操作流畅性能测试通过**
- [ ] 移动端适配测试通过
- [ ] 代码审查通过