---
name: 标签解析系统：#tag语法解析和隐式时间标签
status: open
created: 2025-10-07T00:00:00Z
github: [待创建GitHub Issue]
depends_on: [001, 002]
parallel: true
conflicts_with: []
---

# Task: 标签解析系统：#tag语法解析和隐式时间标签

## Description

实现#tag语法解析器，区别于H1标题的#，开发隐式时间标签自动生成机制，实现标签的创建、关联、显示功能，支持用户自定义标签和系统自动生成的时间标签。

## Acceptance Criteria

- [ ] 实现#tag语法解析器，能够从笔记内容中准确提取标签
- [ ] 区分#tag和H1标题的#，避免解析冲突
- [ ] 开发隐式时间标签自动生成机制（基于笔记创建时间、内容中的时间信息）
- [ ] 实现标签的创建、更新、删除功能
- [ ] 实现标签与笔记的多对多关联关系管理
- [ ] 开发标签显示组件，支持颜色编码和类型区分
- [ ] 实现标签搜索和过滤功能
- [ ] 添加标签使用统计和热门标签显示
- [ ] 编写完整的单元测试和集成测试

## Technical Details

### 标签解析器设计

#### 正则表达式解析
```typescript
class TagParser {
  // 匹配#tag（不包括行首的#，避免与H1冲突）
  private static readonly TAG_REGEX = /(?<!^)#([a-zA-Z0-9_\u4e00-\u9fa5]+)/g;

  // 匹配时间相关的隐式标签
  private static readonly TIME_PATTERNS = {
    date: /\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/g,
    time: /\d{1,2}:\d{2}/g,
    weekday: /(周一|周二|周三|周四|周五|周六|周日|monday|tuesday|wednesday|thursday|friday|saturday|sunday)/gi
  };

  static parseTags(content: string): ParsedTag[] {
    // 解析显式#tag
    // 解析隐式时间标签
    // 返回标准化标签列表
  }
}
```

#### 标签类型定义
```typescript
interface ParsedTag {
  name: string;
  type: 'user' | 'implicit_time' | 'system';
  source: 'explicit' | 'implicit';
  position: { start: number; end: number };
  metadata?: {
    date?: Date;
    confidence?: number;
  };
}

interface TagService {
  extractTags(content: string): Promise<ParsedTag[]>;
  createTag(tagData: CreateTagData): Promise<TagRecord>;
  associateNoteWithTag(noteId: string, tagId: string): Promise<void>;
  removeTagAssociation(noteId: string, tagId: string): Promise<void>;
  getTagsByNote(noteId: string): Promise<TagRecord[]>;
  getNotesByTag(tagId: string): Promise<NoteRecord[]>;
}
```

### 隐式时间标签生成

#### 时间信息提取
```typescript
class ImplicitTimeTagGenerator {
  static generateFromContent(content: string, createdAt: Date): ParsedTag[] {
    const tags: ParsedTag[] = [];

    // 1. 基于创建时间的时间标签
    tags.push(this.createTimeTag(createdAt, 'created'));

    // 2. 从内容中提取日期信息
    const dates = content.match(TagParser.TIME_PATTERNS.date);
    dates?.forEach(dateStr => {
      const date = new Date(dateStr);
      if (this.isValidDate(date)) {
        tags.push(this.createTimeTag(date, 'mentioned'));
      }
    });

    // 3. 从内容中提取星期信息
    const weekdays = content.match(TagParser.TIME_PATTERNS.weekday);
    weekdays?.forEach(weekday => {
      tags.push(this.createWeekdayTag(weekday));
    });

    return tags;
  }

  private static createTimeTag(date: Date, source: string): ParsedTag {
    return {
      name: this.formatTimeTag(date),
      type: 'implicit_time',
      source: 'implicit',
      position: { start: 0, end: 0 },
      metadata: { date, confidence: 0.9 }
    };
  }
}
```

### 标签显示和管理

#### 标签组件设计
```typescript
interface TagComponentProps {
  tag: TagRecord;
  size?: 'small' | 'medium' | 'large';
  clickable?: boolean;
  removable?: boolean;
  onRemove?: () => void;
  onClick?: () => void;
}

const TagComponent: React.FC<TagComponentProps> = ({
  tag,
  size = 'medium',
  clickable = true,
  removable = false,
  onRemove,
  onClick
}) => {
  // 根据标签类型应用不同样式
  // 用户标签：自定义颜色
  // 时间标签：蓝色系
  // 系统标签：灰色系
};
```

#### 标签管理界面
```typescript
interface TagManagerProps {
  noteId: string;
  availableTags: TagRecord[];
  assignedTags: TagRecord[];
  onTagAssign: (tagId: string) => void;
  onTagRemove: (tagId: string) => void;
  onTagCreate: (tagData: CreateTagData) => void;
}
```

### 代码文件影响

- `src/services/tags/parser.ts` - 标签解析器实现
- `src/services/tags/implicit.ts` - 隐式时间标签生成
- `src/services/tags/service.ts` - 标签服务层
- `src/components/tags/Tag.tsx` - 标签显示组件
- `src/components/tags/TagManager.tsx` - 标签管理组件
- `src/hooks/useTags.ts` - 标签相关React hooks
- `src/types/tags.ts` - 标签类型定义

## Dependencies

- [ ] 任务001：数据库schema和关联表完成
- [ ] 任务002：基础笔记CRUD和API完成
- [ ] 现有的正则表达式和文本处理库
- [ ] TypeScript类型系统完整

## Effort Estimate

- Size: M
- Days: 2-3天
- Parallel: true

## Definition of Done

- [ ] #tag语法解析器实现，准确率95%以上
- [ ] 隐式时间标签自动生成机制完成
- [ ] 标签的创建、关联、显示功能完整
- [ ] 标签搜索和过滤功能正常工作
- [ ] 单元测试覆盖率达到90%以上
- [ ] 集成测试验证标签解析和关联功能
- [ ] 代码审查通过
- [ ] 用户文档更新完成