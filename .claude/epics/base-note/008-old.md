---
name: TDD基础设施：测试框架配置和核心工具
status: open
created: 2025-10-07T00:00:00Z
github: [待创建GitHub Issue]
depends_on: []
parallel: true
conflicts_with: []
---

# Task: TDD基础设施：测试框架配置和核心工具

## Description

建立完整的TDD（测试驱动开发）基础设施，包括Jest测试框架配置、React Testing Library、测试数据库、Mock工具和CI/CD集成，为整个项目的TDD开发流程提供坚实基础。

## Acceptance Criteria

- [ ] **TDD原则确立**: 建立Red-Green-Refactor开发循环的标准流程
- [ ] 配置Jest测试框架，支持TypeScript和React组件测试
- [ ] 集成React Testing Library，支持组件交互测试
- [ ] 创建TestDatabase工具类，提供隔离的测试环境
- [ ] 配置测试Mock工具（localStorage、IndexedDB、Observer等）
- [ ] 建立测试覆盖率报告，目标≥90%
- [ ] 配置ESLint和Prettier，确保代码质量
- [ ] 集成GitHub Actions，实现自动化测试流水线
- [ ] 创建TDD开发规范文档和最佳实践指南

## Technical Details

### TDD开发流程

#### Red-Green-Refactor循环
```typescript
// TDD标准流程示例
// 1. RED: 写失败的测试
describe('Note Creation with TDD', () => {
  it('should create note with view positions', async () => {
    // 测试数据
    const noteData = {
      title: 'Test Note',
      content: 'Test content',
      view_positions: {
        'daily': { x: 100, y: 200 },
        'tags': { x: 300, y: 400 }
      }
    };

    // 测试执行（预期失败）
    const noteId = await noteService.create(noteData);
    const savedNote = await noteService.getById(noteId);

    // 断言验证
    expect(savedNote).toBeDefined();
    expect(savedNote.view_positions).toEqual(noteData.view_positions);
  });
});

// 2. GREEN: 实现最小功能让测试通过
// 3. REFACTOR: 重构优化，保持测试通过
```

#### 测试分层架构
```typescript
// 测试层次结构
src/
├── test/
│   ├── setup.ts              # 全局测试配置
│   ├── utils/
│   │   ├── TestDatabase.ts   # 测试数据库工具
│   │   ├── TestHelpers.ts    # 测试辅助函数
│   │   └── mocks/           # Mock对象
│   ├── fixtures/            # 测试数据
│   └── performance/         # 性能基准测试
├── __tests__/              # 单元测试
├── integration/            # 集成测试
└── e2e/                   # 端到端测试
```

### Jest配置
```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/test/setup.ts'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '^@components/(.*)$': '<rootDir>/src/components/$1',
    '^@stores/(.*)$': '<rootDir>/src/stores/$1',
    '^@services/(.*)$': '<rootDir>/src/services/$1'
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/test/**/*',
    '!src/**/*.stories.tsx'
  ],
  coverageThreshold: {
    global: {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90
    }
  },
  testMatch: [
    '<rootDir>/src/**/__tests__/**/*.{ts,tsx}',
    '<rootDir>/src/**/*.{test,spec}.{ts,tsx}'
  ]
};
```

### 测试工具类
```typescript
// src/test/utils/TestDatabase.ts
export class TestDatabase {
  private static instance: TestDatabase;
  private db: Dexie;

  private constructor() {
    this.db = new Dexie('test_noteum');
    this.setupSchema();
  }

  static getInstance(): TestDatabase {
    if (!TestDatabase.instance) {
      TestDatabase.instance = new TestDatabase();
    }
    return TestDatabase.instance;
  }

  async reset(): Promise<void> {
    await this.db.delete();
    await this.db.open();
  }

  async seedTestData(): Promise<TestData> {
    // 提供标准测试数据
  }

  getDB(): Dexie {
    return this.db;
  }
}

// src/test/utils/TestHelpers.ts
export class TestHelpers {
  static createMockNote(overrides: Partial<Note> = {}): Note {
    return {
      id: `note-${Date.now()}`,
      title: 'Test Note',
      content: 'Test content #test',
      created_at: new Date(),
      updated_at: new Date(),
      view_positions: {},
      ...overrides
    };
  }

  static async waitFor(condition: () => boolean, timeout = 5000): Promise<void> {
    // 等待条件满足的辅助函数
  }
}
```

### TDD最佳实践

#### 1. 测试命名规范
```typescript
describe('NoteService', () => {
  describe('create', () => {
    it('should create note with valid data', async () => {
      // 测试正常流程
    });

    it('should throw error with invalid title', async () => {
      // 测试异常情况
    });

    it('should generate ID automatically', async () => {
      // 测试特定功能点
    });
  });
});
```

#### 2. 测试数据管理
```typescript
// 使用工厂模式创建测试数据
class NoteFactory {
  static create(overrides: Partial<Note> = {}): Note {
    return {
      id: faker.datatype.uuid(),
      title: faker.lorem.sentence(),
      content: faker.lorem.paragraph(),
      created_at: faker.date.past(),
      updated_at: faker.date.recent(),
      view_positions: {},
      ...overrides
    };
  }

  static withTags(tags: string[]): Note {
    return this.create({
      content: `Content with ${tags.map(t => `#${t}`).join(' ')}`
    });
  }
}
```

#### 3. Mock策略
```typescript
// 分层Mock，保持测试独立性
jest.mock('@/services/storage/database', () => ({
  db: {
    notes: {
      add: jest.fn(),
      get: jest.fn(),
      update: jest.fn(),
      delete: jest.fn()
    }
  }
}));

// 在测试中配置Mock行为
beforeEach(() => {
  jest.clearAllMocks();
  mockDB.notes.add.mockResolvedValue('note-id-123');
});
```

### 性能测试框架
```typescript
// src/test/performance/noteOperations.test.ts
describe('Note Operations Performance', () => {
  it('should create 100 notes within performance threshold', async () => {
    const startTime = performance.now();

    const promises = Array.from({ length: 100 }, () =>
      noteService.create(TestHelpers.createMockNote())
    );

    await Promise.all(promises);
    const endTime = performance.now();

    expect(endTime - startTime).toBeLessThan(1000); // 1秒内完成
  });

  it('should handle large dataset queries efficiently', async () => {
    // 大数据集查询性能测试
  });
});
```

### CI/CD集成
```yaml
# .github/workflows/tdd.yml
name: TDD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Run type checking
      run: npm run type-check

    - name: Run TDD tests
      run: npm run test:tdd -- --coverage

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: true

  performance:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v3
    - name: Run performance tests
      run: npm run test:performance
```

### 代码文件影响

#### 测试基础设施
- `jest.config.js` - Jest测试框架配置
- `src/test/setup.ts` - 全局测试配置和Mock
- `src/test/utils/` - 测试工具类
- `src/test/fixtures/` - 测试数据文件
- `src/test/performance/` - 性能基准测试

#### CI/CD配置
- `.github/workflows/tdd.yml` - TDD流水线配置
- `.eslintrc.js` - ESLint配置
- `.prettierrc` - Prettier配置

#### 文档
- `docs/tdd-guidelines.md` - TDD开发规范
- `docs/testing-best-practices.md` - 测试最佳实践

## Dependencies

- [ ] Node.js 18+ 环境
- [ ] Jest测试框架
- [ ] React Testing Library
- [ ] TypeScript支持
- [ ] ESLint和Prettier

## Effort Estimate

- Size: M
- Days: 1-2天
- Parallel: true

## Definition of Done

- [ ] TDD基础设施搭建完成，所有配置文件就位
- [ ] 测试框架正常运行，基础测试用例通过
- [ ] 测试覆盖率报告正常生成，目标≥90%
- [ ] CI/CD流水线配置完成，自动化测试执行正常
- [ ] TDD开发规范文档完成，团队已了解流程
- [ ] 性能测试框架就位，基准测试可用
- [ ] 代码质量检查工具配置完成，集成到CI/CD
- [ ] 团队TDD培训完成，开发流程确认