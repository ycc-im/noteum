---
name: base-note
description: 以React Flow为核心的视觉化笔记系统，支持多视图位置管理和基础标签功能
status: backlog
created: 2025-10-06T22:11:38Z
---

# PRD: Base-Note 基础笔记功能

## 1. 项目概述

### 1.1 核心理念
Base-Note 是一个以React Flow为核心的视觉化笔记系统，采用"节点即笔记"的设计理念，让用户能够：
- 在可视化画布上创建和连接笔记
- 通过拖拽和连线表达思维关系
- 在不同视图中灵活组织和查看笔记

### 1.2 技术决策
- **Flow-Based架构**: 每个React Flow节点就是一个笔记
- **JSONB位置存储**: 在notes表中使用JSONB字段管理多视图位置
- **本地优先策略**: 基于IndexedDB的本地存储，确保离线可用

### 1.3 产品定位
面向个人用户的轻量级笔记管理工具，特别适合：
- 需要整理复杂思路的知识工作者
- 喜欢可视化思考的用户
- 注重隐私和数据控制的用户

## 2. 问题陈述

### 2.1 传统笔记的局限性
- **线性限制**: 传统文档笔记无法表达思维间的非线性关系
- **组织困难**: 文件夹层级分类方式僵化，难以体现内容的多维度属性
- **检索低效**: 缺乏直观的可视化导航，查找特定内容耗时
- **关系缺失**: 无法有效记录和展示知识点之间的关联关系

### 2.2 用户痛点
- 想要快速记录灵感时，被复杂的文档结构干扰
- 难以在大量笔记中找到相关内容
- 无法直观地展示项目或知识体系的整体结构
- 不同场景下需要不同的笔记组织方式，但工具不支持

## 3. 用户故事

### 3.1 核心用户画像
- **知识工作者**: 需要整理项目思路、会议记录、学习笔记
- **创意工作者**: 需要可视化地组织和连接创意想法
- **开发者**: 需要记录技术笔记、代码片段、架构设计

### 3.2 主要使用场景
1. **快速记录**: 在任何时候快速捕捉想法和灵感
2. **思维整理**: 将零散的想法通过连线组织成体系
3. **知识管理**: 构建个人知识库，方便后续查找和回顾
4. **项目规划**: 可视化地规划项目步骤和依赖关系

### 3.3 用户故事
- **作为用户，我希望** 在画布上双击就能快速创建笔记节点
- **作为用户，我希望** 通过拖拽连线来表达笔记之间的逻辑关系
- **作为用户，我希望** 同一个笔记在日期视图和标签视图中显示不同位置
- **作为用户，我希望** 使用 #标签 来快速分类和标记笔记内容
- **作为用户，我希望** 支持Markdown格式，方便记录代码和格式化内容

## 4. 功能需求

### 4.1 核心功能 (MVP)

#### 4.1.1 Flow-Based笔记系统
- **节点创建**: 在画布上双击创建新笔记节点
- **节点编辑**: 点击节点进入编辑模式，支持Markdown输入
- **节点连接**: 通过拖拽在节点间创建连线，表达关系
- **节点移动**: 自由拖拽节点位置，自动保存位置信息

#### 4.1.2 多视图位置管理
- **Daily视图**: 按日期组织显示笔记，适合回顾当日记录
- **Tag聚合视图**: 按标签分组显示相关笔记，便于主题整理
- **位置记忆**: 同一笔记在不同视图中保持独立的位置记录
- **视图切换**: 流畅切换不同视图，自动加载对应的位置信息

#### 4.1.3 基础标签系统
- **#tag语法解析**: 识别内容中的#tag格式（区别于Markdown H1标题）
- **隐式时间标签**: 自动添加日期、月份、年份、周数等时间标签
- **标签展示**: 在节点上显示关联的标签
- **标签筛选**: 基于标签快速筛选相关笔记

#### 4.1.4 Markdown支持
- **实时预览**: 编辑时支持Markdown实时预览
- **代码高亮**: 支持多种编程语言的语法高亮
- **基础格式**: 支持标题、列表、链接、图片等常用Markdown语法

### 4.2 技术需求

#### 4.2.1 数据层设计
- **notes表扩展**: 添加view_positions JSONB字段存储多视图位置
- **tags表设计**: 支持标签名称、颜色、元数据等基础信息
- **关联表**: 建立notes和tags的多对多关联关系
- **数据迁移**: 支持数据库结构的版本升级

#### 4.2.2 视图引擎
- **Daily视图算法**: 按时间顺序排列笔记，支持时间线布局
- **Tag视图算法**: 按标签分组，采用力导向或网格布局
- **位置计算**: 新增笔记时自动计算合适的初始位置
- **位置缓存**: 前端缓存位置信息，减少数据库查询

#### 4.2.3 React Flow集成
- **自定义节点**: 支持Markdown渲染的节点组件
- **位置同步**: React Flow位置变化与数据库的同步机制
- **连线管理**: 支持不同类型的连线样式和交互
- **性能优化**: 大量节点时的渲染性能优化

## 5. 非功能需求

### 5.1 性能要求
- **创建响应**: 3秒内完成新笔记创建和位置计算
- **视图切换**: 1秒内完成视图切换和节点重排
- **查询性能**: JSONB位置查询响应时间 < 50ms
- **节点容量**: 支持至少500个节点的流畅操作

### 5.2 可用性要求
- **操作直观**: 双击创建、拖拽移动、点击编辑等自然交互
- **视觉清晰**: 节点样式、标签显示、连线关系清晰易读
- **响应式设计**: 支持不同屏幕尺寸的自适应显示

### 5.3 数据要求
- **本地优先**: 所有数据优先存储在本地IndexedDB
- **数据安全**: 支持数据导出和备份功能
- **离线可用**: 无网络环境下完全可用

## 6. 成功标准

### 6.1 功能完整性
- ✅ Flow-Based笔记创建、编辑、连接功能完整可用
- ✅ JSONB位置存储机制稳定可靠，支持多视图切换
- ✅ 标签系统正确解析#tag语法，自动生成时间标签
- ✅ Markdown渲染准确无误，代码高亮正常显示

### 6.2 性能指标
- ✅ 新笔记创建时间 < 3秒
- ✅ 视图切换时间 < 1秒
- ✅ 标签解析准确率 = 100%
- ✅ 500个节点场景下操作流畅度 > 30fps

### 6.3 用户体验
- ✅ 新用户能在5分钟内掌握基本操作
- ✅ 核心操作路径（创建→编辑→连接）无中断
- ✅ 视觉界面美观现代，符合直觉

## 7. 依赖约束

### 7.1 技术约束
- **框架限制**: 必须基于现有React 19 + TypeScript架构
- **存储限制**: 使用现有Dexie.js存储系统，不能引入新的数据库
- **UI约束**: 必须使用现有shadcn/ui组件库，保持设计一致

### 7.2 依赖管理
- **新增依赖**: 可添加Markdown解析器（react-markdown）和代码高亮库
- **版本兼容**: 确保新依赖与现有依赖版本兼容
- **打包体积**: 控制新增依赖对打包体积的影响

### 7.3 浏览器兼容
- **现代浏览器**: 支持Chrome、Firefox、Safari、Edge的最新版本
- **移动端适配**: 初期以桌面端为主，移动端基础可用即可

## 8. 实施计划

### 8.1 开发阶段
**阶段一：数据层重构**
- 扩展notes表添加view_positions JSONB字段
- 完善tags表和关联表设计
- 实现数据迁移和基础CRUD操作

**阶段二：核心Flow功能**
- 集成React Flow基础功能
- 实现自定义节点组件
- 添加节点创建、编辑、移动交互

**阶段三：标签系统**
- 实现#tag语法解析器
- 添加隐式时间标签自动生成
- 完善标签展示和筛选功能

**阶段四：多视图管理**
- 实现Daily和Tag基础视图
- 添加视图切换和位置管理
- 优化布局算法和性能

### 8.2 TDD开发策略
**测试驱动开发（TDD）原则**:
- **Red-Green-Refactor循环**: 先写失败的测试，再实现功能，最后重构优化
- **测试先行**: 每个功能模块开发前必须先编写完整的测试套件
- **持续集成**: 每次代码提交都必须通过所有测试，测试覆盖率≥90%
- **文档即测试**: 测试用例本身就是功能规范和API文档

**TDD实施计划**:
```typescript
// TDD开发流程示例
// 1. 先写测试（Red）
describe('Note Position Management', () => {
  it('should store and retrieve positions for different views', async () => {
    const noteId = 'note-1';
    const dailyPosition = { x: 100, y: 200 };
    const tagPosition = { x: 300, y: 400 };

    // 测试失败 - 功能未实现
    await positionService.setPosition(noteId, 'daily', dailyPosition);
    await positionService.setPosition(noteId, 'tags', tagPosition);

    const dailyPos = await positionService.getPosition(noteId, 'daily');
    const tagPos = await positionService.getPosition(noteId, 'tags');

    expect(dailyPos).toEqual(dailyPosition);
    expect(tagPos).toEqual(tagPosition);
  });
});

// 2. 实现功能（Green）
// 3. 重构优化（Refactor）
```

**测试分层策略**:
- **单元测试**: 每个函数、类、组件的独立测试
- **集成测试**: 模块间交互的端到端测试
- **性能测试**: 关键路径的性能基准测试
- **用户验收测试**: 基于用户故事的场景测试

## 9. 风险评估

### 9.1 技术风险
- **性能瓶颈**: 大量节点时React Flow渲染性能
- **数据一致性**: JSONB字段更新的并发控制
- **浏览器兼容**: IndexedDB在不同浏览器中的表现差异

### 9.2 产品风险
- **学习成本**: Flow-Based交互方式的学习曲线
- **用户习惯**: 用户从传统笔记工具迁移的适应期
- **功能范围**: MVP功能是否满足用户基本需求

### 9.3 缓解措施
- **性能优化**: 实现虚拟化和懒加载机制
- **数据验证**: 添加数据完整性检查和备份机制
- **用户引导**: 提供完善的新手引导和帮助文档

## 10. 范围之外

### 10.1 本期不包含的功能
- ❌ **智能标签推荐**: 基于内容分析的标签自动推荐
- ❌ **AI辅助功能**: 内容摘要、智能分类等AI功能
- ❌ **协同编辑**: 多用户实时协作编辑
- ❌ **云端同步**: 数据的云端备份和多设备同步
- ❌ **高级视图**: 复杂的视图算法和自定义视图
- ❌ **插件系统**: 第三方插件和扩展支持

### 10.2 后续扩展方向
- **智能升级**: 逐步引入AI辅助的智能标签和内容分析
- **协作功能**: 基于WebRTC的实时协作编辑
- **移动端优化**: 原生移动端应用的适配
- **企业版功能**: 团队管理、权限控制等企业级功能

## 11. 验收标准

### 11.1 功能验收
- [ ] 双击画布空白处可创建新笔记节点
- [ ] 点击节点可进入编辑模式，支持Markdown输入
- [ ] 拖拽节点边缘可创建连线连接其他节点
- [ ] 切换Daily/Tag视图时，节点位置按视图独立显示
- [ ] 内容中#tag被正确识别并高亮显示
- [ ] 自动添加日期、月份等隐式时间标签
- [ ] Markdown内容正确渲染，代码块有语法高亮

### 11.2 性能验收
- [ ] 创建新笔记响应时间 < 3秒
- [ ] 视图切换动画流畅，完成时间 < 1秒
- [ ] 100个节点场景下拖拽操作流畅
- [ ] JSONB位置查询平均响应时间 < 50ms

### 11.3 TDD质量验收
- [ ] **测试先行**: 每个功能模块都有先于实现的测试用例
- [ ] **覆盖率要求**: 核心功能单元测试覆盖率 ≥ 90%
- [ ] **持续集成**: 所有代码提交必须通过完整测试套件
- [ ] **Red-Green-Refactor**: 遵循TDD开发循环，有完整的测试演进记录
- [ ] **测试文档**: 测试用例本身就是完整的功能文档和API规范
- [ ] **性能测试**: 关键操作有明确的性能基准测试
- [ ] **集成测试**: 模块间交互有端到端的测试覆盖
- [ ] **浏览器兼容**: 主流浏览器兼容性测试通过
- [ ] **用户验收**: 基于用户故事的场景测试全部通过

---

**文档版本**: 1.0
**创建时间**: 2025-10-06
**负责团队**: Noteum开发团队
**优先级**: 高（MVP核心功能）