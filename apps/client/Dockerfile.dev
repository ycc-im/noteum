# 前端开发环境 Dockerfile
FROM node:18-alpine

WORKDIR /app

# 安装必要的系统依赖
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++

# 安装 pnpm
RUN npm install -g pnpm@8.15.0

# 复制根目录的 package.json 和 pnpm-workspace.yaml
COPY package.json pnpm-lock.yaml* pnpm-workspace.yaml* ./

# 复制各个包的 package.json
COPY apps/client/package.json ./apps/client/
COPY packages/utils/package.json ./packages/utils/
COPY packages/ui/package.json ./packages/ui/

# 安装依赖（确保vite被正确安装）
RUN pnpm install --frozen-lockfile

# 验证vite是否正确安装
RUN cd /app/apps/client && npx vite --version || (echo "Vite installation failed" && exit 1)

# 复制源代码
COPY apps/client ./apps/client
COPY packages ./packages

# 暴露端口
EXPOSE 5173

# 创建启动脚本
COPY <<EOF /app/start-client.sh
#!/bin/sh
# 确保在正确的目录中
cd /app

# 验证vite可用性
echo "Checking Vite installation..."
if ! npx vite --version; then
  echo "Vite not found, installing..."
  pnpm install --frozen-lockfile
fi

# 启动开发服务器
echo "Starting Vite development server..."
exec pnpm --filter @noteum/client dev
EOF

RUN chmod +x /app/start-client.sh

# 开发模式启动命令
CMD ["/app/start-client.sh"]