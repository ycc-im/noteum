# 消息中间件可视化测试控制台

## 🚀 快速开始

### 一键启动
```bash
# 运行快速启动脚本
./scripts/start-messaging-test.sh
```

这个脚本会自动：
- 启动 Redis 服务（如果未运行）
- 启动后端服务（端口 9168）
- 启动前端应用（端口 9159）
- 在浏览器中打开测试控制台

### 手动启动
如果需要手动启动，请按照以下步骤：

## 概述

这是一个为消息中间件（Redis Stream / Kafka）设计的综合可视化测试平台，提供实时监控、功能测试和性能分析功能。

## 功能特性

### 🎯 实时监控
- **系统状态监控**: 实时显示连接状态、健康状态
- **性能指标**: 消息吞吐量、响应时间、错误率
- **适配器信息**: 当前使用的消息适配器详细信息和功能特性
- **错误统计**: 错误分类、趋势分析和分布图表

### 🧪 功能测试
- **基础功能测试**: 消息生产和消费测试
- **错误恢复测试**: 测试系统的错误恢复能力
- **断路器测试**: 验证断路器模式的工作机制
- **性能基准测试**: 测量系统的基准性能
- **负载测试**: 模拟高负载场景

### 📊 可视化图表
- **消息吞吐量图表**: 实时显示消息数量变化趋势
- **错误趋势图表**: 监控错误数量变化
- **响应时间图表**: 显示系统响应时间分布
- **错误分布饼图**: 展示不同类型错误的分布情况

### ⚙️ 配置管理
- **配置信息查看**: 显示当前消息中间件配置
- **配置模板**: 提供不同环境的配置模板
- **实时配置更新**: 支持配置热更新

## 使用方法

### 1. 启动服务

确保 Redis 或 Kafka 服务正在运行，然后启动服务：

```bash
# 启动后端服务
pnpm dev:services

# 启动前端应用
pnpm dev:client
```

### 2. 访问测试控制台

在浏览器中打开：`http://localhost:9159/messaging-test`

注意：前端应用默认运行在端口 9159，如果该端口被占用，会自动使用下一个可用端口。

### 3. 监控面板使用

#### 实时监控标签页
- 查看系统健康状态概览
- 监控适配器连接状态
- 观察消息吞吐量和错误率
- 查看详细的问题和建议

#### 功能测试标签页
- 选择要运行的测试场景
- 点击"运行选中的测试"执行测试
- 查看详细的测试结果和性能指标
- 可以单独发送测试消息

#### 负载测试标签页
- 设置测试参数（消息数量、大小、并发数）
- 点击"开始负载测试"执行
- 查看负载测试结果和性能分析

#### 配置信息标签页
- 查看当前系统配置
- 了解适配器功能特性
- 监控系统运行时间等指标

## API 端点

测试控制台提供以下 REST API 端点：

### 健康检查
- `GET http://localhost:9168/api/v1/messaging-test/health` - 获取健康状态
- `GET http://localhost:9168/api/v1/messaging-test/metrics` - 获取性能指标

### 消息操作
- `POST http://localhost:9168/api/v1/messaging-test/produce/:topic` - 发送测试消息

### 测试执行
- `POST http://localhost:9168/api/v1/messaging-test/test-scenarios` - 运行测试场景
- `POST http://localhost:9168/api/v1/messaging-test/simulate-load` - 模拟负载测试

### 配置和监控
- `GET http://localhost:9168/api/v1/messaging-test/configuration` - 获取配置信息
- `GET http://localhost:9168/api/v1/messaging-test/adapter-info` - 获取适配器信息
- `POST http://localhost:9168/api/v1/messaging-test/trigger-error` - 触发测试错误
- `GET http://localhost:9168/api/v1/messaging-test/test-report` - 生成测试报告

## 测试场景说明

### 1. 基础生产消费测试 (basic-produce-consume)
测试基本的消息生产和消费功能，验证消息流转是否正常。

### 2. 错误恢复测试 (error-recovery)
测试系统在遇到错误后的恢复能力，包括重连机制和错误处理。

### 3. 断路器测试 (circuit-breaker)
验证断路器模式是否正常工作，包括断路器打开和关闭机制。

### 4. 性能基准测试 (performance-benchmark)
测量系统在不同负载下的性能表现，包括吞吐量和响应时间。

### 5. 负载测试 (load-testing)
模拟高并发场景，测试系统的稳定性和性能极限。

## 监控指标说明

### 系统状态
- **HEALTHY**: 系统运行正常
- **DEGRADED**: 系统性能下降但仍可用
- **UNHEALTHY**: 系统存在严重问题

### 性能指标
- **消息吞吐量**: 单位时间内处理的消息数量
- **响应时间**: 系统处理请求的平均时间
- **错误率**: 错误消息占总消息的比例
- **运行时间**: 系统持续运行的时间

### 错误分类
- **CONNECTION**: 连接相关错误
- **SERIALIZATION**: 序列化错误
- **TIMEOUT**: 超时错误
- **NETWORK**: 网络错误
- **VALIDATION**: 验证错误

## 故障排除

### 常见问题

1. **无法连接到 Redis/Kafka**
   - 检查服务是否运行
   - 验证连接配置是否正确
   - 查看网络连接状态

2. **测试结果为失败**
   - 查看错误信息和日志
   - 检查资源使用情况
   - 验证消息格式是否正确

3. **图表数据显示异常**
   - 确认自动刷新已开启
   - 检查网络连接状态
   - 手动刷新数据

### 调试方法

1. 使用浏览器开发者工具查看网络请求
2. 检查服务端日志输出
3. 验证消息中间件服务状态
4. 使用内置的错误触发功能测试错误处理

## 扩展功能

### 添加新的测试场景
1. 在 `MessagingTestController` 中添加新的测试方法
2. 在前端测试选项中添加对应选项
3. 更新测试结果展示逻辑

### 自定义监控指标
1. 在 `MessagingHealthService` 中添加新的指标收集
2. 在前端图表组件中添加对应的可视化
3. 更新 API 响应格式

### 集成其他消息系统
1. 实现新的消息适配器
2. 更新配置管理以支持新的适配器
3. 在测试控制器中添加相应的测试用例

## 技术栈

- **后端**: NestJS, TypeScript, Redis/Kafka
- **前端**: React, TypeScript, Tailwind CSS, Shadcn/ui, Recharts
- **可视化**: Recharts 图表库
- **实时更新**: 定时轮询机制

## 许可证

本项目采用 MIT 许可证。