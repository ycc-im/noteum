# 笔记创建功能提案

## Why

需要实现完整的笔记创建功能，让用户能够通过简化的新笔记模态框创建笔记并持久化存储。当前模态框UI已经简化完成，但缺少实际的数据提交和后端处理逻辑。通过tRPC接口和Redis Stream的组合，我们可以实现一个高性能、可扩展的笔记创建流程。

## What Changes

### 核心变更

- **添加tRPC客户端集成**: 在前端应用中完整集成tRPC客户端，支持类型安全的API调用
- **实现前端ULID生成**: 为前端添加ULID生成能力，支持客户端ID生成
- **扩展Redis Stream支持**: 增强CacheService以支持Redis Stream操作
- **创建笔记创建API**: 实现完整的笔记创建tRPC路由和业务逻辑
- **集成新笔记模态框**: 将现有模态框与新API集成，实现完整的用户交互流程

### 具体实施变更

1. **前端基础设施**:
   - 安装和配置@trpc/client依赖
   - 创建tRPC客户端配置和类型定义
   - 实现前端ULID工具函数
   - 修改新笔记模态框集成API调用

2. **后端API开发**:
   - 在CacheService中添加Redis Stream操作方法
   - 创建notes tRPC路由器
   - 实现笔记创建mutation和数据验证
   - 添加用户权限检查和错误处理

3. **数据流设计**:
   - 前端生成笔记ID（ULID）
   - 通过tRPC提交笔记数据
   - 后端验证并写入Redis Stream
   - 异步处理和持久化

## 概述

实现通过tRPC接口创建笔记并提交到Redis Stream的完整功能，包括前端ULID生成和后端Redis Stream处理。

## 问题背景

当前新笔记模态框已经简化完成，但缺少实际的笔记创建功能。需要：

1. 在前端生成笔记ID（基于ULID）
2. 通过tRPC接口提交笔记数据
3. 后端将笔记数据写入Redis Stream
4. 确保数据流的完整性和一致性

## 架构分析

### 现有基础设施

- **tRPC**: 已有基础的tRPC服务架构，包含认证路由器
- **ULID**: 后端已有完整的ULID工具类，需要在前端添加相应功能
- **Redis**: 已有CacheService提供基础Redis操作，但缺少Stream支持
- **类型定义**: 已有Note接口和CreateNoteRequest类型

### 缺失组件

1. 前端tRPC客户端集成
2. 前端ULID生成工具
3. 后端笔记创建tRPC路由
4. Redis Stream操作封装
5. 笔记创建业务逻辑

## 实施策略

### 阶段1: 前端基础设施

1. 添加tRPC客户端依赖和配置
2. 创建前端ULID工具函数
3. 集成新笔记模态框与tRPC调用

### 阶段2: 后端API开发

1. 扩展CacheService支持Redis Stream
2. 创建笔记创建tRPC路由
3. 实现笔记数据验证和处理

### 阶段3: 集成测试

1. 端到端功能测试
2. 错误处理和用户体验优化
3. 性能优化

## 技术考虑

### ID生成策略

- 使用ULID确保分布式环境下的唯一性
- 前端生成提供更好的用户体验
- 支持时间排序，便于后续查询

### Redis Stream设计

- 使用笔记相关的stream key
- 包含必要的元数据和时间戳
- 支持消费者组处理

### 错误处理

- 网络错误重试机制
- 用户友好的错误提示
- 数据回滚和一致性保证
